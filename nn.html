<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Blog Management</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Tagify for Tags -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <!-- Flatpickr for Date/Time -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            overflow: hidden; /* Prevent body scroll */
        }
        
        /* App View Management */
        .app-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .app-view.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sidebar Styles & Responsiveness */
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            height: 100vh; /* Full height */
            position: fixed; /* Fixed for mobile overlay */
            top: 0;
            left: 0;
            z-index: 40; /* Above overlay */
        }
        @media (min-width: 768px) { /* md breakpoint */
            #sidebar {
                position: relative; /* Static on desktop */
                transform: translateX(0) !important; /* Ensure visible */
                z-index: auto;
            }
            #sidebar-overlay { display: none !important; }
        }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #d1d5db; font-weight: 500; transition: all 0.2s ease-in-out; white-space: nowrap; }
        .sidebar-link:hover { background-color: #374151; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .sidebar-link i { margin-right: 0.75rem; flex-shrink: 0; }

        /* Quill Editor Height */
        #quill-editor { min-height: 250px; background-color: white; }
        .ql-container.ql-snow { min-height: inherit; font-size: 1rem; /* Ensure consistent font size */ }
        .ql-editor { min-height: inherit; } /* Make editor take full height */
        
        /* Tagify Customization */
        .tagify { --tag-bg: #e0e7ff; --tag-text-color: #3730a3; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; /* Better padding */ }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; padding: 1rem; } /* Added padding */
        .modal.open { display: flex; }
        .modal-content { animation: zoomIn 0.2s ease-out; max-height: 90vh; overflow-y: auto; /* Scroll inside modal */ }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Toast Notification */
        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; z-index: 2000; transition: all 0.3s ease-in-out; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #toast.show { bottom: 20px; }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }

        /* Share Modal Link Style */
        .share-modal-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; text-decoration: none; transition: background-color 0.2s; border: 1px solid #e5e7eb; }
        .share-modal-link:hover { background-color: #f3f4f6; }

        /* Helper for form inputs */
        .input-field { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s; }
        .input-field:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); outline: none; }

        /* Utility button styles */
        .btn { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #4f46e5; color: white; border: 1px solid transparent; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .btn-danger:hover { background-color: #dc2626; }

        /* Loading Placeholder */
        .loading-placeholder { padding: 1rem; text-align: center; color: #6b7280; }

        /* Table Action Buttons */
        .action-btn { padding: 0.25rem; border-radius: 0.25rem; transition: background-color 0.15s; }
        .action-btn:hover { background-color: rgba(0,0,0,0.05); }

        /* Status Badge */
        .status-badge { padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; line-height: 1; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 flex-shrink-0 bg-gray-800 text-white flex flex-col h-full fixed md:relative inset-y-0 left-0 z-40 transform -translate-x-full md:translate-x-0">
        <div class="h-16 flex items-center justify-between px-4 font-bold text-xl border-b border-gray-700">
            Blog Management
            <button id="close-sidebar-btn" class="md:hidden text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="#" class="sidebar-link active" data-view="list-posts"> <i data-lucide="layout-list" class="w-5 h-5"></i> All Posts </a>
            <a href="#" class="sidebar-link" data-view="add-post"> <i data-lucide="plus-square" class="w-5 h-5"></i> Add New Post </a>
            <a href="#" class="sidebar-link" data-view="comments"> <i data-lucide="messages-square" class="w-5 h-5"></i> Comments </a>
            <a href="#" class="sidebar-link" data-view="categories"> <i data-lucide="tags" class="w-5 h-5"></i> Categories </a>
            <a href="#" class="sidebar-link" data-view="analytics"> <i data-lucide="bar-chart-3" class="w-5 h-5"></i> Analytics </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <p class="text-xs text-gray-400 mb-2">v1.0.0</p>
        </div>
    </aside>
    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden hidden"></div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Mobile Header -->
         <header class="md:hidden sticky top-0 bg-white shadow z-20">
             <div class="px-4 py-3 flex justify-between items-center">
                 <h1 class="text-xl font-bold text-indigo-600">Blog Mgmt</h1>
                 <button id="open-sidebar-btn" class="text-gray-700 p-1">
                     <i data-lucide="menu" class="w-6 h-6"></i>
                 </button>
             </div>
         </header>

         <!-- Scrollable Main Content -->
         <main class="flex-1 overflow-x-hidden overflow-y-auto p-6 md:p-10">
            <!-- LIST POSTS VIEW -->
            <div id="list-posts" class="app-view active">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">All Posts</h1>
                    <button id="add-new-post-btn-main" class="btn btn-primary w-full md:w-auto justify-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Post
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="search-posts" placeholder="Search posts..." class="input-field sm:col-span-2 lg:col-span-2">
                        <select id="filter-category" class="input-field"><option value="">All Categories</option></select>
                        <select id="filter-status" class="input-field"><option value="">All Statuses</option><option value="Published">Published</option><option value="Draft">Draft</option><option value="Scheduled">Scheduled</option></select>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[800px]"> <!-- Ensure horizontal scroll -->
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="p-4 w-12 text-left"><input type="checkbox" id="select-all-posts"></th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Title</th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Views</th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Published</th>
                                    <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="posts-table-body" class="divide-y divide-gray-200">
                                <tr><td colspan="7" class="loading-placeholder">Loading posts...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADD/EDIT POST VIEW -->
            <div id="post-form" class="app-view">
                <h1 id="form-title" class="text-3xl font-bold text-gray-800 mb-6">Add New Post</h1>
                <form id="blog-post-form">
                    <input type="hidden" id="post-id">
                    <input type="hidden" id="post-slug">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm"><label for="post-title" class="block text-lg font-semibold mb-2">Title</label><input type="text" id="post-title" placeholder="Post Title" class="w-full text-2xl font-bold input-field" required></div>
                            <div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="p-6 border-b"><label class="block text-lg font-semibold">Content</label></div><div id="quill-editor"></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-sm"><label class="block text-lg font-semibold mb-2">Attachments</label><div id="attachment-dropzone" class="dropzone"><i data-lucide="paperclip"></i><p>Drop files or click</p><input type="file" class="hidden" id="post-attachments" multiple></div><div id="attachment-list" class="mt-4 space-y-2"></div></div>
                            <details class="bg-white rounded-lg shadow-sm"><summary class="summary-toggle">SEO Metadata (Optional)<i data-lucide="chevron-down"></i></summary><div class="p-6 border-t space-y-4"><div><label for="seo-title">Meta Title</label><input type="text" id="seo-title" class="input-field"></div><div><label for="seo-description">Meta Description</label><textarea id="seo-description" rows="3" class="input-field"></textarea></div><div><label for="seo-keywords">Keywords</label><input type="text" id="seo-keywords" class="input-field"></div></div></details>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="section-title">Publish</h2><div class="space-y-4"><div><label for="post-status">Status</label><select id="post-status" class="input-field"><option value="Draft">Draft</option><option value="Published">Published</option><option value="Scheduled">Scheduled</option></select></div><div id="schedule-date-wrapper" class="hidden"><label for="post-schedule-date">Schedule Date</label><input type="text" id="post-schedule-date" placeholder="Select date" class="input-field"></div></div><div class="form-actions"><button type="button" id="save-draft-btn" class="text-gray-600 font-medium hover:text-indigo-600">Save Draft</button><button type="submit" id="publish-btn" class="btn btn-primary">Publish</button></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="section-title">Category</h2><select id="post-category" class="input-field"><option value="Uncategorized">Uncategorized</option></select></div>
                            <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="section-title">Tags</h2><input id="post-tags" placeholder="Add tags..."></div>
                            <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="section-title">Feature Image</h2><div id="image-dropzone" class="dropzone"><i data-lucide="image"></i><p>Drop image or click</p><input type="file" class="hidden" id="post-image" accept="image/*"></div><div id="image-preview-wrapper" class="mt-4 hidden"><img id="image-preview" src="#" alt="Preview"><button type="button" id="remove-image-btn" class="remove-btn">Remove</button></div></div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- COMMENTS VIEW -->
            <div id="comments" class="app-view">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Comments</h1>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="search-comments" placeholder="Search..." class="input-field md:col-span-2">
                        <select id="filter-comment-status" class="input-field"><option value="">All Statuses</option><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Spam">Spam</option></select>
                    </div>
                </div>
                <div id="comments-list" class="space-y-6">
                    <div class="loading-placeholder">Loading comments...</div>
                </div>
            </div>

            <!-- CATEGORIES VIEW -->
            <div id="categories" class="app-view">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                     <h1 class="text-3xl font-bold text-gray-800">Manage Categories</h1>
                     <button id="add-category-btn" class="btn btn-primary w-full md:w-auto justify-center">
                         <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Category
                     </button>
                 </div>
                 <div class="bg-white rounded-lg shadow-sm overflow-hidden max-w-lg mx-auto"> <!-- Max width for better focus -->
                     <ul id="category-list" class="divide-y divide-gray-200 p-6">
                         <li class="loading-placeholder">Loading categories...</li>
                     </ul>
                 </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="analytics" class="app-view">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Blog Analytics</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Posts</p><i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i></div><p id="stats-total-posts" class="stat-value">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Total Views</p><i data-lucide="eye" class="w-5 h-5 text-green-500"></i></div><p id="stats-total-views" class="stat-value">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Pending Comments</p><i data-lucide="messages-square" class="w-5 h-5 text-yellow-500"></i></div><p id="stats-total-comments" class="stat-value">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><div class="flex items-center justify-between"><p class="text-sm font-medium text-gray-500">Published / Drafts</p><i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i></div><p id="stats-published-drafts" class="stat-value">0 / 0</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold mb-4">Popular Posts (by Views)</h2><ul id="popular-posts-list" class="divide-y"><li class="loading-placeholder">Loading...</li></ul></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-xl font-semibold mb-4">Views Over Time (Mock)</h2><div class="h-64 bg-gray-50 flex items-center justify-center"><p class="text-gray-400">Chart Here</p></div></div>
                </div>
            </div>
        </div> <!-- End padding wrapper -->
    </main>

    <!-- Modals -->
    <div id="delete-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4 text-center"><div class="modal-icon bg-red-100 text-red-600"><i data-lucide="trash-2"></i></div><h2 class="text-2xl font-bold mb-2">Delete Post</h2><p class="text-gray-600 mb-6">Delete this post & comments? Cannot be undone.</p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="btn btn-secondary">Cancel</button><button id="confirm-delete-btn" class="btn btn-danger">Delete</button></div></div></div>
    <div id="reply-modal" class="modal"><div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4"><h2 class="text-2xl font-bold mb-4">Reply to Comment</h2><div class="modal-context"><p id="reply-author"></p><p id="reply-original-text"></p></div><form id="reply-form"><input type="hidden" id="reply-comment-id"><textarea id="reply-text" rows="4" placeholder="Write reply..." class="input-field" required></textarea><div class="modal-actions"><button id="cancel-reply-btn" type="button" class="btn btn-secondary">Cancel</button><button id="submit-reply-btn" type="submit" class="btn btn-primary">Submit Reply</button></div></form></div></div>
    <div id="share-modal" class="modal"><div class="modal-content bg-white p-6 rounded-lg shadow-2xl w-full max-w-md m-4"><h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="share-2" class="w-5 h-5 mr-2 text-indigo-600"></i>Share Post</h2><div id="share-modal-content" class="space-y-3"></div><div class="mt-6 flex justify-end"><button id="close-share-btn" class="btn btn-secondary">Close</button></div></div></div>

    <!-- Toast Notification Area -->
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, getDoc, addDoc, doc, updateDoc, 
            deleteDoc, onSnapshot, serverTimestamp, query, where, orderBy, 
            writeBatch, Timestamp, increment
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // REMOVED: Mock Storage imports
        
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8",
            authDomain: "ardaycaawiye-18b89.firebaseapp.com",
            projectId: "ardaycaawiye-18b89",
            storageBucket: "ardaycaawiye-18b89.firebasestorage.app",
            messagingSenderId: "590874185284",
            appId: "1:590874185284:web:6ee7df602c45068e38b611",
            measurementId: "G-SBGSTJWDMR"
        };
        // -----------------------------------------

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCollection = collection(db, "blogPosts");
        const commentsCollection = collection(db, "blogComments");
        const categoriesCollection = collection(db, "blogCategories");

        // --- Global State ---
        let currentView = 'list-posts';
        let editingPostId = null;
        let postToDeleteId = null;
        let commentToReplyId = null;
        let allPosts = [];
        let allComments = [];
        let allCategories = [];
        let unsubscribePosts = () => {};
        let unsubscribeComments = () => {};
        let unsubscribeCategories = () => {};

        // --- Lib Instances ---
        let quill, tagify, schedulePicker;

        // --- DOM Elements --- (Get references to all needed elements)
        const views = document.querySelectorAll('.app-view');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
        const postsTableBody = document.getElementById('posts-table-body');
        const postForm = document.getElementById('blog-post-form');
        const postFormTitle = document.getElementById('form-title');
        const postIdInput = document.getElementById('post-id');
        const postSlugInput = document.getElementById('post-slug');
        const postTitleInput = document.getElementById('post-title');
        const postStatusSelect = document.getElementById('post-status');
        const scheduleDateWrapper = document.getElementById('schedule-date-wrapper');
        const postCategorySelect = document.getElementById('post-category');
        const filterCategorySelect = document.getElementById('filter-category');
        const imageDropzone = document.getElementById('image-dropzone');
        const imageInput = document.getElementById('post-image');
        const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const attachmentDropzone = document.getElementById('attachment-dropzone');
        const attachmentInput = document.getElementById('post-attachments');
        const attachmentList = document.getElementById('attachment-list');
        const commentsListView = document.getElementById('comments-list');
        const categoryListView = document.getElementById('category-list');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const replyModal = document.getElementById('reply-modal');
        const replyForm = document.getElementById('reply-form');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const shareModal = document.getElementById('share-modal');
        const closeShareBtn = document.getElementById('close-share-btn');
        const toast = document.getElementById('toast');
        const selectAllCheckbox = document.getElementById('select-all-posts');

        // =============================================
        // Initialization
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initLibs();
            setupEventListeners();
            showView('list-posts');
            lucide.createIcons();
            initCategoryListener(); // Start listening for categories
        });

        function initLibs() {
            // Quill
            quill = new Quill('#quill-editor', {
                theme: 'snow',
                modules: { toolbar: [/* Toolbar options */] }
            });
            // Tagify
            tagify = new Tagify(document.getElementById('post-tags'));
            // Flatpickr
            schedulePicker = flatpickr("#post-schedule-date", { enableTime: true, dateFormat: "Y-m-d H:i" });
        }
        
        // =============================================
        // Toast Notification Utility
        // =============================================
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg text-white font-semibold shadow-lg transition-all transform ${isError ? 'toast-error' : 'toast-success'}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // =============================================
        // Mock File Upload (Placeholder - Replace with Firebase Storage)
        // =============================================
        async function mockUploadFile(file) {
            showToast(`Simulating upload for ${file.name}...`);
            await new Promise(resolve => setTimeout(resolve, 1500));
            const mockUrl = `https://mockstorage.com/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
            console.log(`Mock Upload: ${file.name} -> ${mockUrl}`);
            // In real app, replace above with Firebase Storage upload and getDownloadURL
            showToast(`Upload complete for ${file.name}!`);
            return { name: file.name, url: mockUrl };
        }

        // =============================================
        // Navigation / View Switching
        // =============================================
        function showView(viewId) {
            unsubscribePosts(); // Stop listeners before switching
            unsubscribeComments();

            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');

            sidebarLinks.forEach(link => link.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-view="${viewId}"]`)?.classList.add('active');
            
            // Start listeners for the new view
            if (viewId === 'add-post') { showPostForm(); } 
            else if (viewId === 'list-posts') { initPostsListener(); } 
            else if (viewId === 'comments') { initPostsListener(); initCommentsListener(); } 
            else if (viewId === 'categories') { renderCategoryList(); } 
            else if (viewId === 'analytics') { fetchAllDataForAnalytics(); }
        }

        // =============================================
        // Data Listeners (Firestore onSnapshot)
        // =============================================
        function initPostsListener() {
            unsubscribePosts = onSnapshot(query(postsCollection, orderBy("createdAt", "desc")), (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPostsTable();
                if (currentView === 'analytics') renderAnalytics(); // Update analytics if visible
            }, error => { console.error("Error fetching posts:", error); /* Error handling */ });
        }
        
        function initCommentsListener() {
            unsubscribeComments = onSnapshot(query(commentsCollection, orderBy("date", "desc")), (snapshot) => {
                allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCommentsList();
                if (currentView === 'analytics') renderAnalytics(); // Update analytics if visible
            }, error => { console.error("Error fetching comments:", error); /* Error handling */ });
        }

        function initCategoryListener() {
             unsubscribeCategories = onSnapshot(query(categoriesCollection, orderBy("name")), (snapshot) => {
                 allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 populateCategoryDropdowns(); // Update dropdowns everywhere
                 if (currentView === 'categories') renderCategoryList(); // Update list if visible
             }, error => { console.error("Error fetching categories:", error); /* Error handling */ });
        }
        
        async function fetchAllDataForAnalytics() {
            try {
                // Fetch fresh data for analytics page load
                const [postSnapshot, commentSnapshot] = await Promise.all([
                    getDocs(query(postsCollection, orderBy("createdAt", "desc"))),
                    getDocs(query(commentsCollection, orderBy("date", "desc")))
                ]);
                allPosts = postSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allComments = commentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAnalytics();
            } catch (error) { /* Error handling */ }
        }

        // =============================================
        // Render Functions (Updating the DOM)
        // =============================================
        function renderPostsTable() {
            postsTableBody.innerHTML = '';
            const search = document.getElementById('search-posts').value.toLowerCase();
            const category = filterCategorySelect.value;
            const status = document.getElementById('filter-status').value;

            let filteredPosts = allPosts.filter(post => 
                (post.title.toLowerCase().includes(search)) &&
                (category === '' || post.category === category) &&
                (status === '' || post.status === status)
            );
            
            if (filteredPosts.length === 0) { /* Show no posts message */ return; }

            filteredPosts.forEach(post => {
                const statusColors = { /* Colors map */ };
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="post-checkbox" data-id="${post.id}"></td>
                    <td class="p-4 align-top"> {/* Align top */}
                        <div class="font-medium text-gray-800">${post.title}</div>
                        <div class="text-xs text-gray-500 mt-1">${(post.tags || []).join(', ')}</div> {/* Smaller tags */}
                    </td>
                    <td class="p-4 text-sm text-gray-600 align-top">${post.category || 'Uncategorized'}</td>
                    <td class="p-4 align-top"><span class="status-badge ${statusColors[post.status] || 'bg-gray-100 text-gray-800'}">${post.status}</span></td>
                    <td class="p-4 text-sm text-gray-600 text-center align-top">${post.views || 0}</td>
                    <td class="p-4 text-sm text-gray-600 align-top">${post.publishDate ? new Date(post.publishDate.toDate()).toLocaleDateString() : 'â€”'}</td>
                    <td class="p-4 align-top">
                        <div class="flex space-x-1 items-center">
                             {/* --- Corrected '../post.html' relative path assuming it's one level up --- */}
                            <a href="../post.html?slug=${post.slug || post.id}" target="_blank" class="action-btn text-green-600" title="View Public Post"><i data-lucide="eye" class="w-4 h-4"></i></a>
                            <button class="edit-btn action-btn text-indigo-600" data-id="${post.id}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4 pointer-events-none"></i></button>
                            <button class="share-btn action-btn text-blue-600" data-id="${post.id}" data-slug="${post.slug || post.id}" data-title="${post.title}" title="Share"><i data-lucide="share-2" class="w-4 h-4 pointer-events-none"></i></button>
                            <button class="delete-btn action-btn text-red-600" data-id="${post.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                    </td>
                `;
                postsTableBody.appendChild(tr);
            });
            lucide.createIcons();
            selectAllCheckbox.checked = false;
        }

        function renderCommentsList() {
            commentsListView.innerHTML = '';
            const search = document.getElementById('search-comments').value.toLowerCase();
            const status = document.getElementById('filter-comment-status').value;
            let filteredComments = allComments.filter(c => /* filter logic */);
            if (filteredComments.length === 0) { /* no comments message */ return; }
            filteredComments.forEach(comment => {/* Render comment card */});
            lucide.createIcons();
        }

        function renderCategoryList() {
             categoryListView.innerHTML = '';
             if (allCategories.length === 0) { /* No categories message */ return; }
             allCategories.forEach(cat => {
                 const li = document.createElement('li');
                 li.className = "py-3 flex justify-between items-center";
                 li.innerHTML = `
                     <span class="font-medium text-gray-800">${cat.name}</span>
                     <button class="delete-category-btn action-btn text-red-600" data-id="${cat.id}" title="Delete"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                 `;
                 categoryListView.appendChild(li);
             });
             lucide.createIcons();
        }

        function populateCategoryDropdowns() {
            const optionsHtml = allCategories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            const defaultOption = '<option value="Uncategorized">Uncategorized</option>';
            postCategorySelect.innerHTML = defaultOption + optionsHtml;
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>' + defaultOption + optionsHtml;
        }

        function renderAnalytics() {
            const totalPosts = allPosts.length;
            const totalViews = allPosts.reduce((acc, post) => acc + (post.views || 0), 0);
            const pendingComments = allComments.filter(c => c.status === 'Pending').length;
            const publishedCount = allPosts.filter(p => p.status === 'Published').length;
            const draftCount = allPosts.filter(p => p.status === 'Draft').length;

            document.getElementById('stats-total-posts').textContent = totalPosts;
            document.getElementById('stats-total-views').textContent = totalViews.toLocaleString();
            document.getElementById('stats-total-comments').textContent = pendingComments;
            document.getElementById('stats-published-drafts').textContent = `${publishedCount} / ${draftCount}`;

            const popularList = document.getElementById('popular-posts-list');
            popularList.innerHTML = '';
            const popularPosts = [...allPosts].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 5);
             
             if(popularPosts.length === 0) { /* no data message */ return; }
             popularPosts.forEach(post => {/* Render popular posts list item */});
        }
        
        // =============================================
        // Form Handling (Add/Edit Post)
        // =============================================
        async function showPostForm(postId = null) { /* Reset logic + Load data if postId exists, using JSON.parse for content */ }
        async function handleFormSubmit(e) { /* Submit logic, using JSON.stringify for content, includes slug generation */ }

        // =============================================
        // File / Image Handling (MOCKED)
        // =============================================
        async function handleImageUpload(file) { /* Same mock logic */ }
        function addAttachmentToList(fileName, fileUrl) { /* Same mock logic */ }
        async function handleAttachmentUpload(files) { /* Same mock logic */ }
        
        // =============================================
        // Delete / Comment / Category Actions
        // =============================================
        function showDeleteModal(postId) { /* Open delete confirmation */ }
        async function confirmDelete() { /* Delete post and comments */ }
        async function updateCommentStatus(commentId, newStatus) { /* Update comment in Firestore */ }
        async function deleteComment(commentId) { /* Delete comment from Firestore */ }
        function showReplyModal(commentId) { /* Open reply form */ }
        async function handleReplySubmit(e) { /* Save reply to comment */ }
        async function addCategory() { /* Prompt and add category */ }
        async function deleteCategory(categoryId) { /* Confirm and delete category */ }

        // =============================================
        // Share Modal Logic
        // =============================================
        function showShareModal(postId, postSlug, postTitle) { /* Populate and open share modal */ }

        // =============================================
        // Event Listeners Setup
        // =============================================
        function setupEventListeners() {
            // Sidebar Navigation & Mobile Toggle
            sidebarLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showView(link.dataset.view); if (window.innerWidth < 768) toggleMobileSidebar(false); }));
            openSidebarBtn?.addEventListener('click', () => toggleMobileSidebar(true));
            closeSidebarBtn?.addEventListener('click', () => toggleMobileSidebar(false));
            sidebarOverlay.addEventListener('click', () => toggleMobileSidebar(false));

            // Add New Buttons
            document.getElementById('add-new-post-btn-main').addEventListener('click', () => showView('add-post'));
            addCategoryBtn.addEventListener('click', addCategory);

            // List View Filters
            document.getElementById('search-posts').addEventListener('input', renderPostsTable);
            filterCategorySelect.addEventListener('change', renderPostsTable);
            document.getElementById('filter-status').addEventListener('change', renderPostsTable);

            // Select All Checkbox
            selectAllCheckbox.addEventListener('change', (e) => postsTableBody.querySelectorAll('.post-checkbox').forEach(cb => cb.checked = e.target.checked));

            // List View Table Actions (Delegation)
            postsTableBody.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const shareBtn = e.target.closest('.share-btn');
                if (editBtn) showPostForm(editBtn.dataset.id);
                if (deleteBtn) showDeleteModal(deleteBtn.dataset.id);
                if (shareBtn) showShareModal(shareBtn.dataset.id, shareBtn.dataset.slug, shareBtn.dataset.title);
            });
            
            // Delete Modal Buttons
            confirmDeleteBtn.addEventListener('click', confirmDelete);
            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('open'));
            
            // Post Form Submit & Draft
            postForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('save-draft-btn').addEventListener('click', () => { postStatusSelect.value = "Draft"; handleFormSubmit(new Event('submit', { bubbles: true, cancelable: true })); });
            postStatusSelect.addEventListener('change', (e) => { scheduleDateWrapper.classList.toggle('hidden', e.target.value !== 'Scheduled'); /* Update publish btn text */ });
            
            // Image & Attachment Upload (MOCKED)
            imageDropzone.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', e => handleImageUpload(e.target.files[0]));
            removeImageBtn.addEventListener('click', () => { /* Clear image preview */ });
            attachmentDropzone.addEventListener('click', () => attachmentInput.click());
            attachmentInput.addEventListener('change', e => handleAttachmentUpload(e.target.files));

            // Comments View Filters & Actions (Delegation)
            document.getElementById('search-comments').addEventListener('input', renderCommentsList);
            document.getElementById('filter-comment-status').addEventListener('change', renderCommentsList);
            commentsListView.addEventListener('click', e => { /* Handle approve/spam/delete/reply */ });
            
            // Category List Actions (Delegation)
             categoryListView.addEventListener('click', e => {
                 const deleteBtn = e.target.closest('.delete-category-btn');
                 if (deleteBtn) deleteCategory(deleteBtn.dataset.id);
             });

            // Reply Modal Buttons
            replyForm.addEventListener('submit', handleReplySubmit);
            cancelReplyBtn.addEventListener('click', () => replyModal.classList.remove('open'));

            // Share Modal Close
             closeShareBtn.addEventListener('click', () => shareModal.classList.remove('open'));
             shareModal.addEventListener('click', (e) => { if (e.target.id === 'share-modal') shareModal.classList.remove('open'); });
        }

        // --- Mobile Sidebar Toggle Function ---
        function toggleMobileSidebar(forceOpen) {
             if (forceOpen === true) { // Explicitly open
                 sidebar.classList.remove('-translate-x-full');
                 sidebarOverlay.classList.remove('hidden');
             } else if (forceOpen === false) { // Explicitly close
                 sidebar.classList.add('-translate-x-full');
                 sidebarOverlay.classList.add('hidden');
             } else { // Toggle
                 sidebar.classList.toggle('-translate-x-full');
                 sidebarOverlay.classList.toggle('hidden');
             }
        }

    </script>
</body>
</html>
