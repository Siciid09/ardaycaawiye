<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdayCaawiye - Somaliland Form 4 Exams Hub</title>
    
    <link rel="icon" href="https://play-lh.googleusercontent.com/BlV02BLnJvkzu-3R716uXz3VwIjBLYOfjZdSZeeJbtU8zSFcrOLMX492HoVCTxldrA49kwyYY9uv3-mIUp9LBOM=w480-h960-rw">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ArdayCaawiye">
    <link rel="apple-touch-icon" href="https://play-lh.googleusercontent.com/BlV02BLnJvkzu-3R716uXz3VwIjBLYOfjZdSZeeJbtU8zSFcrOLMX492HoVCTxldrA49kwyYY9uv3-mIUp9LBOM=w480-h960-rw"> 
    
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="antialiased">

    <header id="header" class="bg-white/80 backdrop-blur-lg fixed top-0 left-0 right-0 z-50 transition-all duration-300 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="nav-link text-2xl font-bold gradient-text">ArdayCaawiye</a>
            <nav class="hidden md:flex items-center space-x-6 font-medium">
                <a href="index.html" class="nav-link hover:text-blue-700 active-nav">HOME</a>
                <a href="#exams" class="nav-link hover:text-blue-700">EXAMS</a>
                <a href="#books" class="nav-link hover:text-blue-700">BOOKS</a>
                <a href="#scholarships" class="nav-link hover:text-blue-700">SCHOLARSHIPS</a>
                <a href="blog.html" class="nav-link hover:text-blue-700">BLOG</a>
                <a href="#about" class="nav-link hover:text-blue-700">ABOUT</a>
                <a href="#contact" class="nav-link hover:text-blue-700">CONTACT</a>
            </nav>
            <div class="hidden md:flex items-center space-x-4">
                <a href="login.html" id="signup-btn" class="nav-link text-blue-700 px-5 py-2 rounded-full font-semibold hover:bg-blue-50">SIGN IN</a>
                <button id="logout-btn" class="hidden text-red-600 px-5 py-2 rounded-full font-semibold hover:bg-red-50">LOGOUT</button>
                <a href="#download" id="download-btn" class="nav-link gradient-bg text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 transform hover:scale-105">DOWNLOAD</a>
                <a href="admin.html" id="admin-dashboard-btn" class="hidden nav-link gradient-bg text-white px-5 py-2 rounded-full font-semibold hover:opacity-90 transform hover:scale-105">DASHBOARD</a>
            </div>
            <button id="mobile-menu-btn" class="md:hidden text-gray-700"><i data-lucide="menu"></i></button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 space-y-2 bg-white">
              <a href="index.html" class="block nav-link hover:text-blue-700 py-2">HOME</a>
              <a href="#exams" class="block nav-link hover:text-blue-700 py-2">EXAMS</a>
              <a href="#books" class="block nav-link hover:text-blue-700 py-2">BOOKS</a>
              <a href="#scholarships" class="block nav-link hover:text-blue-700 py-2">SCHOLARSHIPS</a>
              <a href="blog.html" class="block nav-link hover:text-blue-700 py-2">BLOG</a>
              <a href="#about" class="block nav-link hover:text-blue-700 py-2">ABOUT</a>
              <a href="#contact" class="block nav-link hover:text-blue-700 py-2">CONTACT</a>
              <a href="login.html" id="mobile-signup-btn" class="block nav-link text-center text-blue-700 border border-blue-700 rounded-md py-2 mt-2">SIGN IN</a>
              <button id="mobile-logout-btn" class="hidden w-full text-center text-red-600 border border-red-600 rounded-md py-2 mt-2">LOGOUT</button>
              <a href="#download" id="mobile-download-btn" class="block nav-link gradient-bg text-white text-center rounded-md py-2 mt-2">DOWNLOAD</a>
              <a href="admin.html" id="mobile-admin-dashboard-btn" class="hidden nav-link gradient-bg text-white text-center rounded-md py-2 mt-2">DASHBOARD</a>
        </div>
    </header>

    <main>
        <section id="home">
            <div class="bg-white pt-24 md:pt-32">
                <div class="container mx-auto px-6">
                    <div class="grid md:grid-cols-2 gap-12 items-center">
                        <div class="text-center md:text-left">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 leading-tight mb-6">Ace Your <span class="gradient-text">Form 4</span> National Exams</h1>
                            <p class="text-lg text-gray-600 max-w-xl mx-auto md:mx-0 mb-8">The #1 App for Somaliland Form 4 students. Access past papers, ebooks, verified answers, and interactive quizzes.</p>
                                <div class="flex justify-center md:justify-start flex-wrap gap-4 mb-8">
                                    <a href="#" class="apple-store-link bg-black text-white px-6 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-800">
                                        <i data-lucide="apple" class="w-6 h-6"></i><div><p class="text-xs">Download on the</p><p class="text-lg font-semibold -mt-1">App Store</p></div>
                                    </a>
                                    <a href="https://play.google.com/store/apps/details?id=com.ardaycaawiye.app" target="_blank" class="google-play-link bg-black text-white px-6 py-3 rounded-lg flex items-center gap-3 hover:bg-gray-800">
                                      <img src="https://www.pngkit.com/png/full/14-146203_white-play-png-white-google-play-logo.png" class="w-6 h-6" alt="Google Play Icon">
                                        <div><p class="text-xs">GET IT ON</p><p class="text-lg font-semibold -mt-1">Google Play</p></div>
                                    </a>
                                </div>
                        </div>
                        <div class="relative w-full h-[500px] flex justify-center items-center mt-12 md:mt-0">
                            
                            <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.firebasestorage.app/o/test%2FScreenshot_20251019_103748.jpg?alt=media&token=25c0556a-3b42-40e9-9db8-089315e36e05" alt="App Screenshot 1" class="absolute w-64 h-auto rounded-2xl shadow-2xl z-20 transform -translate-x-20 md:-translate-x-24 translate-y-4 rotate-[-12deg]">
                             <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.firebasestorage.app/o/test%2FScreenshot_20251019_103742.jpg?alt=media&token=668b82d0-1ee9-4481-89d1-f11f10c70738" alt="App Screenshot 2" class="absolute w-64 h-auto rounded-2xl shadow-2xl z-30 transform translate-y-8">
                             <img src="https://firebasestorage.googleapis.com/v0/b/ardaycaawiye-18b89.firebasestorage.app/o/test%2FScreenshot_20251019_104011.jpg?alt=media&token=87e33986-0175-4e77-89b9-c23b9c8cea19" alt="App Screenshot 3" class="absolute w-64 h-auto rounded-2xl shadow-2xl z-20 transform translate-x-20 md:translate-x-24 translate-y-12 rotate-[12deg]">
                            
                            <div class="absolute inset-0 z-40">
                                <div class="viral-card absolute top-[10%] left-[5%] p-3 rounded-xl shadow-lg flex items-center gap-3 text-white" style="animation-delay: 0s;">
                                    <i data-lucide="eye" class="w-6 h-6 opacity-80"></i>
                                    <div><p class="font-bold text-lg">11M+</p><p class="text-xs opacity-80 -mt-1">Views</p></div>
                                </div>
                                <div class="viral-card absolute bottom-[15%] left-[10%] p-3 rounded-xl shadow-lg flex items-center gap-3 text-white" style="animation-delay: 1.5s;">
                                    <i data-lucide="download" class="w-6 h-6 opacity-80"></i>
                                    <div><p class="font-bold text-lg">300K+</p><p class="text-xs opacity-80 -mt-1">Downloads</p></div>
                                </div>
                                <div class="viral-card absolute top-[12%] right-[8%] p-3 rounded-xl shadow-lg flex items-center gap-3 text-white" style="animation-delay: 3s;">
                                    <i data-lucide="file-text" class="w-6 h-6 opacity-80"></i>
                                    <div><p class="font-bold text-lg">500+</p><p class="text-xs opacity-80 -mt-1">Exams</p></div>
                                </div>
                                <div class="viral-card absolute bottom-[20%] right-[5%] p-3 rounded-xl shadow-lg flex items-center gap-3 text-white" style="animation-delay: 4.5s;">
                                    <i data-lucide="book-copy" class="w-6 h-6 opacity-80"></i>
                                    <div><p class="font-bold text-lg">30+</p><p class="text-xs opacity-80 -mt-1">Subjects</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="py-24">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 reveal">
                        <h2 class="text-3xl md:text-4xl font-bold">Find Recent Exam Papers</h2>
                        <p class="text-gray-500 mt-4 max-w-2xl mx-auto">Quickly find the Form 4 resources you need for your upcoming national exams.</p>
                    </div>
                    <div id="home-exams-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
                    <div class="text-center mt-12">
                        <a href="#exams" class="nav-link gradient-bg text-white px-8 py-3 rounded-full font-semibold hover:opacity-90 transform hover:scale-105 inline-block">View All Exams</a>
                    </div>
                </div>
            </div>

            <div class="py-24 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 reveal">
                        <h2 class="text-3xl md:text-4xl font-bold">Explore Our Digital Library</h2>
                        <p class="text-gray-500 mt-4 max-w-2xl mx-auto">Get a head start with our curated collection of books and study guides.</p>
                    </div>
                    <div id="home-books-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                    </div>
                    <div class="text-center mt-12">
                        <a href="#books" class="nav-link gradient-bg text-white px-8 py-3 rounded-full font-semibold hover:opacity-90 transform hover:scale-105 inline-block">View All Books</a>
                    </div>
                </div>
            </div>


            <div class="py-24">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 reveal">
                        <h2 class="text-3xl md:text-4xl font-bold">Your Path to Success in 3 Steps</h2>
                        <p class="text-gray-500 mt-4 max-w-2xl mx-auto">A simple, clear path to mastering your Form 4 national exams.</p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div class="reveal" style="transition-delay: 150ms;"><div class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4 text-2xl font-bold">1</div><h3 class="text-xl font-bold mb-2">Download</h3><p class="text-gray-600 px-4">Get the app to access all our free resources.</p></div>
                        <div class="reveal" style="transition-delay: 300ms;"><div class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4 text-2xl font-bold">2</div><h3 class="text-xl font-bold mb-2">Practice</h3><p class="text-gray-600 px-4">Use past papers and quizzes to test your knowledge.</p></div>
                        <div class="reveal" style="transition-delay: 450ms;"><div class="bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4 text-2xl font-bold">3</div><h3 class="text-xl font-bold mb-2">Succeed</h3><p class="text-gray-600 px-4">Go into your exam with confidence and achieve your goals.</p></div>
                    </div>
                </div>
            </div>

            <div class="py-24 bg-white">
                <div class="container mx-auto px-6"><div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-8 text-center">
                    <div class="stat-card reveal"><i data-lucide="users" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="120000">0</h3><p class="text-gray-500 mt-2">Students</p></div>
                    <div class="stat-card reveal" style="transition-delay: 50ms;"><i data-lucide="download" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="300000">0</h3><p class="text-gray-500 mt-2">Downloads</p></div>
                    <div class="stat-card reveal" style="transition-delay: 100ms;"><i data-lucide="eye" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="11000000">0</h3><p class="text-gray-500 mt-2">Views</p></div>
                    <div class="stat-card reveal" style="transition-delay: 150ms;"><i data-lucide="file-text" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="500">0</h3><p class="text-gray-500 mt-2">Exams</p></div>
                    <div class="stat-card reveal" style="transition-delay: 200ms;"><i data-lucide="book-copy" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="30">0</h3><p class="text-gray-500 mt-2">Subjects</p></div>
                    <div class="stat-card reveal" style="transition-delay: 250ms;"><i data-lucide="trending-up" class="w-10 h-10 gradient-text mx-auto mb-2"></i><h3 class="text-3xl font-bold gradient-text" data-target="95">0%</h3><p class="text-gray-500 mt-2">Success Rate</p></div>
                </div></div>
            </div>

              <div class="py-24 overflow-hidden">
                    <div class="container mx-auto px-6">
                        <div class="text-center mb-16 reveal">
                            <h2 class="text-3xl md:text-4xl font-bold">Trusted by Students</h2>
                            <p class="text-gray-500 mt-4 max-w-2xl mx-auto">See what your peers are saying about ArdayCaawiye.</p>
                        </div>
                        <div class="relative">
                            <div id="carousel-track-container" class="overflow-hidden">
                                <div id="carousel-track" class="flex">
                                    <div class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 p-4"><div class="bg-white p-8 rounded-2xl h-full shadow-md"><p class="text-gray-600 mb-6 italic">"This platform was essential for my Form 4 exam preparation. The past papers from previous years were exactly what I needed to practice and build my confidence. Highly recommended!"</p><div class="flex items-center"><img src="https://i.pravatar.cc/48?u=ayan" class="rounded-full mr-4" alt="User Avatar"><div><p class="font-bold">Ayan H.</p><p class="text-sm text-gray-500">Hargeisa</p></div></div></div></div>
                                    <div class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 p-4"><div class="bg-white p-8 rounded-2xl h-full shadow-md"><p class="text-gray-600 mb-6 italic">"The quizzes are my favorite feature. Getting instant feedback helped me learn from my mistakes quickly. The app is even better, I use it on the bus to school."</p><div class="flex items-center"><img src="https://i.pravatar.cc/48?u=mohamed" class="rounded-full mr-4" alt="User Avatar"><div><p class="font-bold">Mohamed A.</p><p class="text-sm text-gray-500">Burao</p></div></div></div></div>
                                    <div class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 p-4"><div class="bg-white p-8 rounded-2xl h-full shadow-md"><p class="text-gray-600 mb-6 italic">"I struggled with Physics, but the topic-by-topic quizzes and ebooks on ArdayCaawiye made a huge difference. I feel so much more prepared for the national exam."</p><div class="flex items-center"><img src="https://i.pravatar.cc/48?u=fatima" class="rounded-full mr-4" alt="User Avatar"><div><p class="font-bold">Fatima Y.</p><p class="text-sm text-gray-500">Berbera</p></div></div></div></div>
                                    <div class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 p-4"><div class="bg-white p-8 rounded-2xl h-full shadow-md"><p class="text-gray-600 mb-6 italic">"The best part is having all the past papers in one place, with answers! It saved me so much time searching. The app is a must-have for every Form 4 student."</p><div class="flex items-center"><img src="https://i.pravatar.cc/48?u=abdi" class="rounded-full mr-4" alt="User Avatar"><div><p class="font-bold">Abdi K.</p><p class="text-sm text-gray-500">Borama</p></div></div></div></div>
                                </div>
                            </div>
                            <div id="carousel-dots" class="flex justify-center gap-2 mt-8"></div>
                        </div>
                    </div>
                </div>

            <div class="py-12">
                   <div class="container mx-auto px-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <a href="https://wa.me/252633227084" target="_blank" class="whatsapp-link bg-gradient-to-r from-green-500 to-teal-500 text-white p-8 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-6 hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                                <div class="flex items-center gap-5 text-center md:text-left">
                                    <i data-lucide="message-circle" class="w-12 h-12 flex-shrink-0"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">Join our Community</h3>
                                        <p class="opacity-90">Get help and discuss with fellow students on WhatsApp.</p>
                                    </div>
                                </div>
                                <span class="bg-white text-green-600 font-bold px-6 py-3 rounded-full mt-4 md:mt-0 whitespace-nowrap">Join Now</span>
                            </a>
                            <a href="#" target="_blank" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white p-8 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-6 hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                                <div class="flex items-center gap-5 text-center md:text-left">
                                    <i data-lucide="send" class="w-12 h-12 flex-shrink-0"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">Get Instant Updates</h3>
                                        <p class="opacity-90">Subscribe to our Telegram channel for the latest news.</p>
                                    </div>
                                </div>
                                <span class="bg-white text-blue-600 font-bold px-6 py-3 rounded-full mt-4 md:mt-0 whitespace-nowrap">Subscribe</span>
                            </a>
                        </div>
                   </div>
            </div>

            <div id="download" class="py-24">
                <div class="container mx-auto px-6">
                    <div class="gradient-bg rounded-2xl p-12 md:p-16 text-white text-center reveal">
                        <h2 class="text-3xl md:text-4xl font-bold mb-4">Ready to Score Higher?</h2>
                        <p class="text-lg opacity-90 mb-8 max-w-3xl mx-auto">The ultimate exam toolkit is one tap away. Get instant access to all resources by downloading the app now.</p>
                        <div class="flex flex-wrap gap-4 justify-center">
                            <a href="#" class="apple-store-link bg-white text-blue-700 px-6 py-3 rounded-lg flex items-center gap-3 font-bold hover:bg-gray-200">
                                <i data-lucide="apple" class="w-6 h-6"></i><div><p class="text-xs">Download on the</p><p class="text-lg font-semibold -mt-1">App Store</p></div>
                            </a>
                            <a href="https://play.google.com/store/apps/details?id=com.ardaycaawiye.app" target="_blank" class="google-play-link bg-white text-blue-700 px-6 py-3 rounded-lg flex items-center gap-3 font-bold hover:bg-gray-200">
                                <img src="https://img.icons8.com/ios_filled/512/228BE6/google-play.png" class="w-6 h-6" alt="Google Play Icon">
                                <div><p class="text-xs">GET IT ON</p><p class="text-lg font-semibold -mt-1">Google Play</p></div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="exams" class="py-24 md:py-32 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12"><h2 class="text-3xl md:text-4xl font-bold">All Past Exam Papers</h2><p class="text-gray-500 mt-4 max-w-2xl mx-auto">Find every exam paper you need, organized for easy access.</p></div>
                
                <div class="mb-8 p-4 bg-gray-50 rounded-lg flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="exam-search" placeholder="Search by exam title..." class="w-full md:w-1/3 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="exam-year-filter" class="w-full md:w-auto p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Filter by Year</option></select>
                    <select id="exam-subject-filter" class="w-full md:w-auto p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Filter by Subject</option></select>
                </div>

                <div id="exams-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="text-center py-10 col-span-full">Loading exams...</div></div>
                
                <div id="exams-pagination" class="flex justify-center items-center flex-wrap gap-2 md:gap-4 mt-12"></div>
            </div>
        </section>

        <section id="books" class="py-24 md:py-32">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold">Digital Library & Guides</h2><p class="text-gray-500 mt-4 max-w-2xl mx-auto">Browse our collection of general knowledge books and subject-specific guides.</p></div>
                
                <div class="mb-8 p-4 bg-gray-50 rounded-lg flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="book-search" placeholder="Search by book title or author..." class="w-full md:w-1/3 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="book-subject-filter" class="w-full md:w-auto p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Filter by Subject</option></select>
                </div>

                <div id="books-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"><div class="text-center py-10 col-span-full">Loading books...</div></div>
                
                <div id="books-pagination" class="flex justify-center items-center flex-wrap gap-2 md:gap-4 mt-12"></div>
            </div>
        </section>

        <section id="scholarships" class="py-24 md:py-32 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold">Scholarship Opportunities</h2>
                    <p class="text-gray-500 mt-4 max-w-2xl mx-auto">Explore these opportunities to fund your future education. Apply now!</p>
                </div>
                <div id="scholarships-list" class="max-w-4xl mx-auto space-y-6">
                    </div>
            </div>
        </section>

        <section id="blog" class="py-24 md:py-32">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold">Our Blog & Study Tips</h2><p class="text-gray-500 mt-4 max-w-2xl mx-auto">Explore articles on study strategies, exam tips, and student wellness from our team.</p></div>
                <div id="blog-posts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
            </div>
        </section>

        <section id="about" class="py-24 md:py-32 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center max-w-4xl mx-auto">
                    <h2 class="text-4xl font-extrabold gradient-text mb-4">Empowering Somaliland's Future</h2>
                    <p class="text-lg text-gray-600">ArdayCaawiye was born from a simple yet powerful idea: every student deserves the best tools to succeed. We are a passionate team dedicated to making high-quality educational resources accessible to all Form 4 students across Somaliland.</p>
                </div>

                <div class="grid md:grid-cols-2 gap-12 mt-20 items-center">
                    <div>
                        <img src="https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=2084&auto=format&fit=crop" class="rounded-2xl shadow-lg" alt="Team working together">
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Our Mission</h3>
                            <p class="text-gray-600">Our mission is to bridge the educational gap by providing a comprehensive, user-friendly digital platform. We believe that by centralizing past exams, textbooks, and study guides, we can level the playing field, helping students build confidence and achieve academic excellence. We're not just an app; we're a study partner for the next generation of leaders, thinkers, and innovators in Somaliland.</p>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Who We Serve</h3>
                            <p class="text-gray-600">We are committed to serving the ambitious Form 4 students of Somaliland. Whether you're in Hargeisa, Burao, Berbera, or any town in between, our platform is designed for you. We understand the challenges of preparing for national exams and aim to provide the support and resources needed to turn academic goals into reality.</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-24">
                    <h2 class="text-3xl md:text-4xl font-bold mb-12">Meet the Team</h2>
                    <div class="grid sm:grid-cols-1 md:grid-cols-3 gap-10">
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-lg text-center reveal">
                            <img src="https://xsgames.co/randomusers/assets/avatars/male/74.jpg" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-200" alt="Mubarik Osman Abdi">
                            <h4 class="text-xl font-bold text-gray-900">Mubarik Osman Abdi</h4>
                            <p class="text-blue-600 font-semibold">Full Stack Developer</p>
                            <p class="text-gray-500 mt-2 text-sm">The architect of ArdayCaawiye, Mubarik combines his software engineering expertise with a passion for marketing to build and grow platforms that make a difference.</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-lg text-center reveal" style="transition-delay: 200ms;">
                            <img src="https://xsgames.co/randomusers/assets/avatars/male/56.jpg" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-200" alt="Khadar Abdi Abidallahi">
                            <h4 class="text-xl font-bold text-gray-900">Khadar Abdi Abidallahi</h4>
                            <p class="text-blue-600 font-semibold">Telecommunication Engineer</p>
                            <p class="text-gray-500 mt-2 text-sm">Khadar ensures our platform is robust, scalable, and accessible. His engineering background is key to our technical infrastructure and seamless user experience.</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-lg text-center reveal" style="transition-delay: 400ms;">
                            <img src="https://xsgames.co/randomusers/assets/avatars/male/46.jpg" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-200" alt="Farah Hussen">
                            <h4 class="text-xl font-bold text-gray-900">Farah Hussen</h4>
                            <p class="text-blue-600 font-semibold">Digital & Telecom Specialist</p>
                            <p class="text-gray-500 mt-2 text-sm">Farah drives our digital strategy, blending his telecom engineering skills with creative digital marketing to connect with and support students across the nation.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="contact" class="py-24 md:py-32">
            <div class="container mx-auto px-6 max-w-4xl">
                <div class="text-center mb-16"><h2 class="text-3xl md:text-4xl font-bold">Get In Touch</h2><p class="text-gray-500 mt-4 max-w-2xl mx-auto">We're here to help. Select a contact method below or send us a message.</p></div>
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <div class="space-y-6">
                        <a href="https://wa.me/252633227084" target="_blank" class="whatsapp-link flex items-center p-4 border rounded-lg hover:bg-gray-50"><i data-lucide="message-circle" class="w-8 h-8 text-green-500 mr-4"></i><div><p class="font-bold">WhatsApp</p><p class="text-gray-600">+252 63 3227084</p></div></a>
                        <a href="mailto:info@ardaycaawiye.com" class="flex items-center p-4 border rounded-lg hover:bg-gray-50"><i data-lucide="mail" class="w-8 h-8 text-blue-500 mr-4"></i><div><p class="font-bold">Email Support</p><p class="text-gray-600">info@ardaycaawiye.com</p></div></a>
                        <div class="flex items-center p-4 border rounded-lg"><i data-lucide="phone" class="w-8 h-8 text-red-500 mr-4"></i><div><p class="font-bold">Call Us</p><p class="text-gray-600">633227084 / 636637456</p></div></div>
                    </div>
                    <form id="contact-form" class="space-y-4">
                        <input type="text" id="contact-name" placeholder="Your Name" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input type="email" id="contact-email" placeholder="Your Email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <textarea id="contact-message" placeholder="Your Message" rows="5" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        <button type="submit" class="w-full gradient-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90">Send Message</button>
                        <p id="contact-success" class="text-green-600 text-center font-semibold mt-2 hidden">Thank you! Your message has been sent.</p>
                    </form>
                </div>
            </div>
        </section>
        
        <section id="signup" class="py-24 md:py-32">
              <div class="container mx-auto px-6 max-w-md"><div class="bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold text-center mb-1">Create Account</h2><p class="text-gray-500 text-center mb-6">Please go to our <a href="login.html" class="text-blue-600 font-bold hover:underline">Sign In</a> page.</p></div></div>
        </section>
    </main>

    <div id="pdf-preview-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-4xl h-[90vh] flex flex-col relative">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="pdf-title" class="font-bold text-lg">Access Full Document</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-black text-3xl">×</button>
            </div>
            <div class="flex-grow relative flex items-center justify-center overflow-hidden p-4 bg-gray-200">
                <img src="https://images.unsplash.com/photo-1549633030-8962852b318b?q=80&w=2070&auto=format=fit=crop" class="absolute inset-0 w-full h-full object-cover filter blur-md scale-110" alt="Blurred Document">

                <div class="relative z-10 bg-white/80 backdrop-blur-sm p-8 rounded-2xl text-center shadow-xl max-w-lg">
                    <i data-lucide="lock" class="w-16 h-16 text-blue-600 mb-4 mx-auto"></i>
                    <h2 class="text-2xl font-bold mb-2">Download the App to View</h2>
                    <p class="text-gray-700 mb-6">This content is exclusively available in the ArdayCaawiye mobile app. Get full offline access, answer keys, and more!</p>
                    <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center">
                         <a href="#" class="apple-store-link bg-black text-white px-6 py-3 rounded-lg flex items-center gap-3 w-full sm:w-auto justify-center"><i data-lucide="apple" class="w-6 h-6"></i><div><p class="text-xs">Download on the</p><p class="text-lg font-semibold -mt-1">App Store</p></div></a>
                         <a href="https://play.google.com/store/apps/details?id=com.ardaycaawiye.app" target="_blank" class="google-play-link bg-black text-white px-6 py-3 rounded-lg flex items-center gap-3 w-full sm:w-auto justify-center">
                            <img src="https://www.pngkit.com/png/full/14-146203_white-play-png-white-google-play-logo.png" class="w-6 h-6" alt="Google Play Icon">
                            <div><p class="text-xs">GET IT ON</p><p class="text-lg font-semibold -mt-1">Google Play</p></div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="blog-modal" class="fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        </div>

    <div id="coming-soon-modal" class="fixed inset-0 bg-black/70 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-sm text-center p-8 relative shadow-xl">
            <button id="close-coming-soon-btn" class="absolute top-2 right-4 text-gray-500 hover:text-black text-4xl">×</button>
            <i data-lucide="apple" class="w-16 h-16 text-gray-800 mb-4 mx-auto"></i>
            <h2 class="text-2xl font-bold mb-2">Coming Soon!</h2>
            <p class="text-gray-700 mb-6">Our iOS app is currently in development and will be available on the App Store soon.</p>
            <button id="coming-soon-ok-btn" class="gradient-bg text-white font-bold py-2 px-8 rounded-lg hover:opacity-90">
                OK
            </button>
        </div>
    </div>


    <footer class="bg-gray-900 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-3 gap-8 text-center md:text-left">
                <div class="md:col-span-1">
                    <h3 class="text-2xl font-bold mb-2">ArdayCaawiye</h3>
                    <p class="text-gray-400 max-w-md mx-auto md:mx-0">
                        Your dedicated partner for academic success. We provide Somaliland's Form 4 students with a comprehensive digital library of past exams, textbooks, and study guides. Our mission is to make quality educational resources accessible to every student, helping them build confidence and achieve their goals. Prepare smarter, not harder, with ArdayCaawiye.
                    </p>
                </div>
                <div class="md:col-span-2 grid grid-cols-2 md:grid-cols-3 gap-8">
                    <div>
                        <h4 class="font-bold text-white mb-3">Quick Links</h4>
                        <nav class="flex flex-col space-y-2">
                            <a href="index.html" class="nav-link text-gray-400 hover:text-white">Home</a>
                            <a href="#exams" class="nav-link text-gray-400 hover:text-white">Exams</a>
                            <a href="#books" class="nav-link text-gray-400 hover:text-white">Books</a>
                            <a href="#scholarships" class="nav-link text-gray-400 hover:text-white">Scholarships</a>
                        </nav>
                    </div>
                     <div>
                        <h4 class="font-bold text-white mb-3">Company</h4>
                        <nav class="flex flex-col space-y-2">
                            <a href="#about" class="nav-link text-gray-400 hover:text-white">About Us</a>
                            <a href="blog.html" class="nav-link text-gray-400 hover:text-white">Blog</a>
                            <a href="#contact" class="nav-link text-gray-400 hover:text-white">Contact</a>
                        </nav>
                    </div>
                    <div>
                        <h4 class="font-bold text-white mb-3">Get the App</h4>
                        <nav class="flex flex-col space-y-2">
                            <a href="#" class="apple-store-link text-gray-400 hover:text-white">App Store</a>
                            <a href="https://play.google.com/store/apps/details?id=com.ardaycaawiye.app" target="_blank" class="google-play-link text-gray-400 hover:text-white">Google Play</a>
                        </nav>
                    </div>
                </div>
            </div>
            <div class="mt-10 border-t border-gray-700 pt-8 text-center"><p class="text-gray-500">© 2025 ArdayCaawiye. Developed by <a href="https://hiigsitech.com" target="_blank" class="hover:text-white underline">Hiigsitech</a>.</p></div>
        </div>
    </footer>
// --- Firebase Imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc, getDoc, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyDuqswofpquk8aUbCOZCGjdYLUivBEh7a8", // Replace with your actual config
    authDomain: "ardaycaawiye-18b89.firebaseapp.com",
    projectId: "ardaycaawiye-18b89",
    storageBucket: "ardaycaawiye-18b89.appspot.com",
    messagingSenderId: "590874185284",
    appId: "1:590874185284:web:6ee7df602c45068e38b611"
};

// --- Firebase Initialization ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

// --- DOM Elements ---
const header = document.getElementById('header');
const sections = document.querySelectorAll('main > section'); // Used only on index.html
const navLinks = document.querySelectorAll('.nav-link');
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const mobileMenu = document.getElementById('mobile-menu');

// Auth & Nav Buttons
const signupBtn = document.getElementById('signup-btn');
const logoutBtn = document.getElementById('logout-btn');
const mobileSignupBtn = document.getElementById('mobile-signup-btn');
const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
const downloadBtn = document.getElementById('download-btn');
const adminDashboardBtn = document.getElementById('admin-dashboard-btn');
const mobileDownloadBtn = document.getElementById('mobile-download-btn');
const mobileAdminDashboardBtn = document.getElementById('mobile-admin-dashboard-btn');

// Modal Elements
const comingSoonModal = document.getElementById('coming-soon-modal');
const closeComingSoonBtn = document.getElementById('close-coming-soon-btn');
const comingSoonOkBtn = document.getElementById('coming-soon-ok-btn');
const pdfModal = document.getElementById('pdf-preview-modal');
const closeModalBtn = document.getElementById('close-modal-btn');

// Dynamic Link Elements
const appleStoreLinks = document.querySelectorAll('.apple-store-link');
const googlePlayLinks = document.querySelectorAll('.google-play-link');
const whatsappLinks = document.querySelectorAll('.whatsapp-link');
const whatsappText = document.getElementById('whatsapp-text'); // Specific text element in Contact

// --- Global State ---
let allExams = [];
let currentExamPage = 1;
const examsPerPage = 12;

let allBooks = [];
let currentBookPage = 1;
const booksPerPage = 12;

let allBlogPosts = []; // Cache for blog posts on blog.html
let currentUser = null; // Cache for current user state
let commentsUnsubscribe = null; // Firestore listener for comments

// =========================================================================
// Initialization and Core Logic
// =========================================================================

// --- Determine Current Page ---
const currentPage = window.location.pathname.split('/').pop() || 'index.html';

// --- Load Dynamic Site Settings ---
async function loadSiteSettings() {
    console.log("Loading site settings...");
    try {
        const settingsRef = doc(db, "settings", "siteConfig");
        const docSnap = await getDoc(settingsRef);

        let settings = {
            googlePlayUrl: "https://play.google.com/store/apps/details?id=com.ardaycaawiye.app", // Default
            appStoreUrl: "#", // Default (triggers Coming Soon)
            whatsappUrl: "https://wa.me/252633227084", // Default
            whatsappDisplay: "+252 63 3227084" // Default
        };

        if (docSnap.exists()) {
            const data = docSnap.data();
            console.log("Fetched settings:", data);
            settings.googlePlayUrl = data.googlePlayUrl || settings.googlePlayUrl;
            settings.appStoreUrl = data.appStoreUrl || settings.appStoreUrl;
            settings.whatsappUrl = data.whatsappUrl || settings.whatsappUrl;
            settings.whatsappDisplay = data.whatsappDisplay || settings.whatsappUrl.replace('https://wa.me/', '+').replace(/[^+\d]/g, ''); // Extract number
        } else {
             console.log("siteConfig document not found, using defaults.");
        }
        
        // Apply settings to all relevant links
        googlePlayLinks.forEach(link => link.href = settings.googlePlayUrl);
        whatsappLinks.forEach(link => link.href = settings.whatsappUrl);
        if (whatsappText) whatsappText.textContent = settings.whatsappDisplay;
        
        // App Store links trigger the "Coming Soon" modal unless a valid URL is set
        appleStoreLinks.forEach(link => {
            if (settings.appStoreUrl && settings.appStoreUrl !== "#") {
                link.href = settings.appStoreUrl;
                // Remove existing listener if needed (safer)
                link.removeEventListener('click', showComingSoonPopup);
            } else {
                 link.href = "#"; // Ensure it doesn't navigate
                 link.addEventListener('click', showComingSoonPopup);
            }
        });

    } catch (error) {
        console.error("Error loading site settings:", error);
        // Fallback to defaults if fetch fails
        appleStoreLinks.forEach(link => {
             link.href = "#";
             link.addEventListener('click', showComingSoonPopup);
        });
        googlePlayLinks.forEach(link => link.href = "https://play.google.com/store/apps/details?id=com.ardaycaawiye.app");
        whatsappLinks.forEach(link => link.href = "https://wa.me/252633227084");
        if (whatsappText) whatsappText.textContent = "+252 63 3227084";
    }
}

// --- Auth State Change Listener (Handles Admin Check) ---
onAuthStateChanged(auth, async (user) => {
    currentUser = user; // Store user state globally
    let isLoggedIn = !!user;
    let isAdmin = false;

    if (isLoggedIn) {
        try {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                isAdmin = true;
                console.log("User is Admin");
            } else {
                 console.log("User is logged in but not Admin");
            }
        } catch (error) {
            console.error("Error checking admin role:", error);
        }
    } else {
         console.log("User is not logged in");
    }
    
    updateNavUI(isLoggedIn, isAdmin);

    // If on login page and logged in, redirect to home
    if (isLoggedIn && currentPage === 'login.html') {
         window.location.href = 'index.html';
         return; // Stop further processing on this page
    }

    // Refresh comment form if on post page
    if (currentPage === 'post.html') {
        const postId = getCurrentPostIdFromUrl();
        if (postId) {
            renderCommentForm(postId, user);
        }
    }
});

function updateNavUI(isLoggedIn, isAdmin) {
    // Show/Hide appropriate buttons based on admin status
    if (isAdmin) {
        [downloadBtn, mobileDownloadBtn].forEach(el => el?.classList.add('hidden'));
        [adminDashboardBtn, mobileAdminDashboardBtn].forEach(el => el?.classList.remove('hidden'));
    } else {
        [downloadBtn, mobileDownloadBtn].forEach(el => el?.classList.remove('hidden'));
        [adminDashboardBtn, mobileAdminDashboardBtn].forEach(el => el?.classList.add('hidden'));
    }

    // Handle signup/logout buttons
    [signupBtn, mobileSignupBtn].forEach(el => el?.classList.toggle('hidden', isLoggedIn));
    [logoutBtn, mobileLogoutBtn].forEach(el => el?.classList.toggle('hidden', !isLoggedIn));

     // Update text on Signup/Signin buttons
     const signinText = "SIGN IN";
     const signupText = "SIGN UP"; // Or keep as SIGN IN if preferred
     if (signupBtn) signupBtn.textContent = isLoggedIn ? '' : signinText;
     if (mobileSignupBtn) mobileSignupBtn.textContent = isLoggedIn ? '' : signinText;
}

// Add logout functionality
[logoutBtn, mobileLogoutBtn].forEach(btn => {
    if(btn) btn.addEventListener('click', () => signOut(auth));
});

// =========================================================================
// Page-Specific Logic
// =========================================================================

// --- Logic for index.html (SPA Sections) ---
if (currentPage === 'index.html' || currentPage === '') {
    // --- SPA Navigation (Only for index.html sections) ---
    const showSection = (hash) => {
        const targetId = hash ? hash.substring(1) : 'home';
        
        // Find the section element only within the index page's main
        const mainElement = document.querySelector('main');
        const sectionsNodeList = mainElement ? mainElement.querySelectorAll('section') : [];
        
        sectionsNodeList.forEach(s => { s.style.display = 'none'; });
        
        const sectionToShow = document.getElementById(targetId);
        
        if (sectionToShow) {
             sectionToShow.style.display = 'block';
             // Only scroll if it's not the initial load of #home
             if (targetId !== 'home' || window.location.hash) {
                 // Slightly delay scroll to allow content to render
                 setTimeout(() => {
                    const headerHeight = header ? header.offsetHeight : 80; // Estimate header height
                    const elementPosition = sectionToShow.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - headerHeight - 20; // Adjust offset
                    
                     window.scrollTo({ 
                        top: offsetPosition, 
                        behavior: 'smooth' 
                     });
                 }, 100);
             }
             updateActiveNavForSPA(targetId); // Use SPA-specific nav update

            // Load content if not already loaded (original logic)
            const isLoaded = sectionToShow.dataset.loaded === 'true';
             if (!isLoaded && targetId !== 'home') { // Home content loads separately
                 if (targetId === 'exams') loadExamsData();
                 if (targetId === 'books') loadBooksData();
                 if (targetId === 'scholarships') loadScholarshipsData();
                 // Blog section on homepage is just a preview, handled by loadHomeBlogPosts
                 // About and Contact are static HTML
                 sectionToShow.dataset.loaded = 'true';
             }
        } else if (targetId === 'home') {
             // Ensure #home section is shown if no other section matches
             const homeSection = document.getElementById('home');
             if (homeSection) homeSection.style.display = 'block';
             updateActiveNavForSPA('home');
        } else {
             // Fallback if targetId doesn't exist (e.g., broken link)
             const homeSection = document.getElementById('home');
             if (homeSection) homeSection.style.display = 'block';
              updateActiveNavForSPA('home');
        }
    };

    const updateActiveNavForSPA = (activeId) => {
         // Reset all nav links first
         document.querySelectorAll('header nav a, #mobile-menu a').forEach(link => {
             link.classList.remove('active-nav');
         });

         let activeLinkSelector;
        if (['exams', 'books', 'scholarships', 'about', 'contact'].includes(activeId)) {
            activeLinkSelector = `header nav a[href="#${activeId}"], #mobile-menu a[href="#${activeId}"]`;
        } else {
             activeLinkSelector = `header nav a[href="index.html"], #mobile-menu a[href="index.html"]`; // Default to HOME
        }
        
         document.querySelectorAll(activeLinkSelector).forEach(link => {
             link.classList.add('active-nav');
         });
    };

    // Event listeners specific to index.html SPA navigation
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            // Only handle hash links for SPA sections on index.html
            if (href && href.startsWith('#')) {
                e.preventDefault();
                // Update hash without adding to history stack for cleaner navigation
                // history.replaceState(null, null, href); 
                 // Or use pushState if you want back/forward to navigate sections
                 history.pushState(null, null, href); 
                showSection(href);
                if (mobileMenu) mobileMenu.classList.add('hidden'); // Close mobile menu
            } 
            // Let full page links (like blog.html) navigate normally
        });
    });

     // Handle back/forward buttons for SPA sections
     window.addEventListener('popstate', () => showSection(window.location.hash || '#home'));

    // Initial section display on index.html load
    showSection(window.location.hash || '#home');

     // Load initial homepage content (previews)
     loadHomeExamsPreview();
     loadHomeBooksPreview();
     // loadHomeBlogPostsPreview(); // Add this if you want blog preview too
     setupCarousel(); // Setup carousel only on index

     // Load data for SPA sections if they exist
     if (document.getElementById('exams')) initializeExamsSection();
     if (document.getElementById('books')) initializeBooksSection();
     if (document.getElementById('scholarships')) loadScholarshipsData(); // Static data, load directly

} else if (currentPage === 'blog.html') {
    // --- Logic for blog.html ---
    loadBlogList();

} else if (currentPage === 'post.html') {
    // --- Logic for post.html ---
    const postId = getCurrentPostIdFromUrl();
    if (postId) {
        loadSinglePost(postId);
        // Comments are loaded within loadSinglePost after content is ready
    } else {
        // Handle case where no slug is provided
        const container = document.getElementById('post-content-container');
        if (container) container.innerHTML = '<h1 class="text-3xl font-bold text-red-600">Error: Blog post not specified.</h1><p>Please return to the blog list.</p>';
    }
} else if (currentPage === 'login.html') {
     // --- Logic for login.html ---
     // The onAuthStateChanged handles redirecting if already logged in.
     // Render the login form initially.
     renderAuthForm(true); // Assuming login.html always starts with login view
}

// =========================================================================
// Data Loading Functions (Called by Page-Specific Logic)
// =========================================================================

// --- Homepage Preview Loaders ---
async function loadHomeExamsPreview() {
    const container = document.getElementById('home-exams-list');
    if (!container) return; // Only run if element exists
    container.innerHTML = createPlaceholder(8, 'exam');
    try {
        const q = query(collection(db, "exams"), orderBy("year", "desc"), limit(8));
        const querySnapshot = await getDocs(q);
        let html = '';
        if (querySnapshot.empty) {
            html = '<p class="col-span-full text-center text-gray-500">No recent exams found.</p>';
        } else {
            querySnapshot.forEach((doc) => {
                const exam = doc.data();
                const title = exam.title || `${exam.subject || 'Exam'} - ${exam.year || ''}`;
                html += `<a href="#" onclick="showPdfPreviewModal(null, '${title.replace(/'/g, "\\'")}')" class="group flex flex-col justify-between bg-white p-5 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1.5 transition-all duration-300"><div><h4 class="font-bold text-lg">${title}</h4><p class="text-gray-500 text-sm">Year: ${exam.year}</p></div><div class="mt-4 text-left"><span class="inline-block bg-blue-100 text-blue-700 text-sm font-bold px-4 py-1 rounded-full group-hover:bg-blue-600 group-hover:text-white">View Details</span></div></a>`;
            });
        }
        container.innerHTML = html;
        lucide.createIcons(); // Re-render icons if needed
    } catch (error) {
        console.error("Error loading home exams:", error);
        container.innerHTML = '<p class="col-span-full text-center text-red-500">Could not load exams.</p>';
    }
}

async function loadHomeBooksPreview() {
    const container = document.getElementById('home-books-list');
     if (!container) return;
    container.innerHTML = createPlaceholder(6, 'book');
    try {
        const q = query(collection(db, "generalBooks"), limit(6));
        const querySnapshot = await getDocs(q);
        let html = '';
        if (querySnapshot.empty) {
            html = '<p class="col-span-full text-center text-gray-500">No books found.</p>';
        } else {
            querySnapshot.forEach((doc) => {
                const book = doc.data();
                html += `<div class="bg-gray-50 rounded-lg shadow-md overflow-hidden flex flex-col group">
                    <img src="${book.coverImageUrl || 'https://placehold.co/400x600/e2e8f0/4a5568?text=No+Cover'}" alt="${book.title}" class="h-56 w-full object-cover">
                    <div class="p-4 flex flex-col flex-grow justify-between">
                        <div>
                            <h4 class="font-bold truncate group-hover:text-blue-600">${book.title}</h4>
                            <p class="text-sm text-gray-500">${book.author || 'Unknown Author'}</p>
                        </div>
                        <button onclick="showPdfPreviewModal(null, '${book.title.replace(/'/g, "\\'")}')" class="mt-4 text-blue-600 font-semibold text-sm text-left self-start">Read Now →</button>
                    </div>
                </div>`;
            });
        }
        container.innerHTML = html;
        lucide.createIcons();
    } catch (error) {
         console.error("Error loading home books:", error);
         container.innerHTML = '<p class="col-span-full text-center text-red-500">Could not load books.</p>';
    }
}

// --- Full Data Loaders for SPA Sections ---
async function loadExamsData() {
    const container = document.getElementById('exams-list');
    if(!container) return;
    container.innerHTML = createPlaceholder(12, 'exam');

    try {
        const q = query(collection(db, "exams"), orderBy("year", "desc"));
        const querySnapshot = await getDocs(q);
        
        allExams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const years = [...new Set(allExams.map(e => e.year))].filter(Boolean).sort((a,b) => b-a);
        const subjects = [...new Set(allExams.map(e => e.subject))].filter(Boolean).sort();
        const yearFilter = document.getElementById('exam-year-filter');
        const subjectFilter = document.getElementById('exam-subject-filter');
        if (yearFilter) yearFilter.innerHTML = '<option value="">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
        if (subjectFilter) subjectFilter.innerHTML = '<option value="">All Subjects</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join('');
        
        renderFilteredExams(); // Render initial list
    } catch (error) {
         console.error("Error loading exams data:", error);
         if (container) container.innerHTML = '<p class="col-span-full text-center text-red-500">Could not load exams.</p>';
    }
}

function initializeExamsSection() {
     const searchInput = document.getElementById('exam-search');
     const yearFilter = document.getElementById('exam-year-filter');
     const subjectFilter = document.getElementById('exam-subject-filter');

     if (searchInput) searchInput.addEventListener('input', () => { currentExamPage = 1; renderFilteredExams(); });
     if (yearFilter) yearFilter.addEventListener('change', () => { currentExamPage = 1; renderFilteredExams(); });
     if (subjectFilter) subjectFilter.addEventListener('change', () => { currentExamPage = 1; renderFilteredExams(); });
     
     loadExamsData(); // Initial data load
}

function renderFilteredExams() {
    const container = document.getElementById('exams-list');
    if (!container) return;

    const searchVal = document.getElementById('exam-search')?.value.toLowerCase() || '';
    const yearVal = document.getElementById('exam-year-filter')?.value || '';
    const subjectVal = document.getElementById('exam-subject-filter')?.value || '';
    
    const filteredExams = allExams.filter(exam => {
        const title = exam.title || `${exam.subject || ''} ${exam.year || ''}`;
        const titleMatch = title.toLowerCase().includes(searchVal);
        const yearMatch = !yearVal || exam.year == yearVal;
        const subjectMatch = !subjectVal || exam.subject == subjectVal;
        return titleMatch && yearMatch && subjectMatch;
    });

    const totalPages = Math.ceil(filteredExams.length / examsPerPage);
    const startIndex = (currentExamPage - 1) * examsPerPage;
    const paginatedExams = filteredExams.slice(startIndex, startIndex + examsPerPage);

    let html = '';
    if(paginatedExams.length === 0) {
         html = '<p class="col-span-full text-center text-gray-500 py-10">No exams match your criteria.</p>';
    } else {
        paginatedExams.forEach(exam => {
            const imageUrl = exam.coverImageUrl ? exam.coverImageUrl : getSubjectIconUrl(exam.subject);
            const title = exam.title || `${exam.subject || 'Exam'} - ${exam.year || ''}`;

            html += `<div class="bg-white p-4 rounded-xl border shadow-sm flex items-center gap-4 group hover:border-blue-500 transition-all duration-200">
                        <img src="${imageUrl}" alt="${exam.subject || 'Exam'}" class="w-20 h-24 object-cover rounded-md flex-shrink-0 bg-gray-200">
                        <div class="flex flex-col justify-between h-full w-full">
                            <div>
                                <h4 class="font-bold text-md leading-tight group-hover:text-blue-600">${title}</h4>
                                <p class="text-gray-500 text-sm mt-1">Subject: ${exam.subject || 'General'} | Year: ${exam.year}</p>
                            </div>
                            <button onclick="showPdfPreviewModal(null, '${title.replace(/'/g, "\\'")}')" class="mt-2 text-blue-600 font-semibold hover:underline text-left self-start">View Now →</button>
                        </div>
                    </div>`;
         });
    }
    container.innerHTML = html;
    lucide.createIcons();
    
    const paginationContainer = document.getElementById('exams-pagination');
    if (paginationContainer) {
        renderPagination(totalPages, 'exams-pagination', (page) => { 
             currentExamPage = page; 
             renderFilteredExams(); 
             // Scroll to top of list smoothly
             const listTop = container.offsetTop;
             const headerHeight = header ? header.offsetHeight : 80;
             window.scrollTo({top: listTop - headerHeight - 20, behavior: 'smooth'}); 
        });
    }
}

async function loadBooksData() {
    const container = document.getElementById('books-list');
    if (!container) return;
    container.innerHTML = createPlaceholder(8, 'book');

    try {
        const querySnapshot = await getDocs(collection(db, "generalBooks"));
        allBooks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const subjects = [...new Set(allBooks.map(b => b.subject))].filter(Boolean).sort();
        const subjectFilter = document.getElementById('book-subject-filter');
        if (subjectFilter) subjectFilter.innerHTML = '<option value="">All Subjects</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join('');

        renderFilteredBooks(); // Render initial list
    } catch (error) {
        console.error("Error loading books data:", error);
        if (container) container.innerHTML = '<p class="col-span-full text-center text-red-500">Could not load books.</p>';
    }
}

function initializeBooksSection() {
    const searchInput = document.getElementById('book-search');
    const subjectFilter = document.getElementById('book-subject-filter');

    if (searchInput) searchInput.addEventListener('input', () => { currentBookPage = 1; renderFilteredBooks(); });
    if (subjectFilter) subjectFilter.addEventListener('change', () => { currentBookPage = 1; renderFilteredBooks(); });

    loadBooksData(); // Initial data load
}

function renderFilteredBooks() {
    const container = document.getElementById('books-list');
    if (!container) return;

    const searchVal = document.getElementById('book-search')?.value.toLowerCase() || '';
    const subjectVal = document.getElementById('book-subject-filter')?.value || '';

    const filteredBooks = allBooks.filter(book => {
        const titleMatch = (book.title || '').toLowerCase().includes(searchVal);
        const authorMatch = (book.author || '').toLowerCase().includes(searchVal);
        const subjectMatch = !subjectVal || book.subject == subjectVal;
        return (titleMatch || authorMatch) && subjectMatch;
    });

    const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
    const startIndex = (currentBookPage - 1) * booksPerPage;
    const paginatedBooks = filteredBooks.slice(startIndex, startIndex + booksPerPage);

    let html = '';
    if (paginatedBooks.length === 0) {
        html = '<p class="col-span-full text-center text-gray-500 py-10">No books match your criteria.</p>';
    } else {
        paginatedBooks.forEach(book => {
            html += `<div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col group">
                <img src="${book.coverImageUrl || 'https://placehold.co/400x600/e2e8f0/4a5568?text=No+Cover'}" alt="${book.title || 'Book'}" class="h-56 w-full object-cover">
                <div class="p-4 flex flex-col flex-grow justify-between">
                    <div>
                        <h4 class="font-bold truncate group-hover:text-blue-600">${book.title}</h4>
                        <p class="text-sm text-gray-500">${book.author || 'Unknown Author'}</p>
                    </div>
                    <button onclick="showPdfPreviewModal(null, '${(book.title || '').replace(/'/g, "\\'")}')" class="mt-4 text-blue-600 font-semibold text-sm text-left self-start">Read Now →</button>
                </div>
            </div>`;
        });
    }
    container.innerHTML = html;
     lucide.createIcons();

     const paginationContainer = document.getElementById('books-pagination');
     if (paginationContainer) {
        renderPagination(totalPages, 'books-pagination', (page) => { 
             currentBookPage = page; 
             renderFilteredBooks(); 
             const listTop = container.offsetTop;
             const headerHeight = header ? header.offsetHeight : 80;
             window.scrollTo({top: listTop - headerHeight - 20, behavior: 'smooth'}); 
        });
     }
}

function loadScholarshipsData() {
    const container = document.getElementById('scholarships-list');
    if (!container) return;

    // Static data as before
    const scholarships = [
        { title: "Somaliland Future Leaders Scholarship", provider: "Ministry of Education", deadline: "Dec 15, 2025", field: "STEM" },
        { title: "Hargeisa Tech Innovators Grant", provider: "HiigsiTech Foundation", deadline: "Jan 30, 2026", field: "Computer Science" },
        { title: "Red Sea Maritime Studies Bursary", provider: "Berbera Port Authority", deadline: "Feb 10, 2026", field: "Maritime Engineering" },
        { title: "Gabiley Agri-Business Scholarship", provider: "Somaliland Agri-Fund", deadline: "Feb 28, 2026", field: "Agriculture" },
        { title: "National Health Professionals Fund", provider: "Ministry of Health", deadline: "Mar 05, 2026", field: "Medicine" },
    ];

    container.innerHTML = scholarships.map(s => `
        <div class="bg-gray-50 border rounded-lg p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <span class="inline-block bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full mb-2">${s.field}</span>
                <h3 class="text-xl font-bold">${s.title}</h3>
                <p class="text-gray-600 mt-1">Provided by: <span class="font-semibold">${s.provider}</span></p>
                <p class="text-red-600 text-sm mt-1">Deadline: ${s.deadline}</p>
            </div>
            <a href="#" class="gradient-bg text-white font-semibold px-5 py-2 rounded-lg mt-4 sm:mt-0 flex-shrink-0">Learn More</a>
        </div>
    `).join('');
     lucide.createIcons();
}

// --- Blog List Page (blog.html) ---
async function loadBlogList() {
    const container = document.getElementById('blog-list-container');
    if (!container) return;
    container.innerHTML = createPlaceholder(6, 'book'); // Use book placeholder styling

    try {
        const q = query(collection(db, "blogs"), where("status", "==", "published"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        allBlogPosts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (allBlogPosts.length === 0) {
            container.innerHTML = '<p class="col-span-full text-center text-gray-500">No blog posts found.</p>';
            return;
        }

        container.innerHTML = allBlogPosts.map(post => {
            const excerpt = post.content ? stripHtml(post.content).substring(0, 150) + '...' : 'No content available.';
            const postUrl = `post.html?slug=${post.slug || post.id}`; // Use slug if available, else ID
            return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col group">
                <a href="${postUrl}">
                   <img src="${post.imageUrl || 'https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?q=80&w=870&auto=format=fit=crop'}" alt="${post.title}" class="h-56 w-full object-cover">
                </a>
                <div class="p-6 flex flex-col flex-grow">
                    <h4 class="text-xl font-bold group-hover:text-blue-600 transition-colors"><a href="${postUrl}">${post.title}</a></h4>
                    <p class="text-sm text-gray-500 mt-1">By ${post.authorName || 'ArdayCaawiye Team'} • ${post.createdAt ? post.createdAt.toDate().toLocaleDateString() : ''}</p>
                    <p class="text-gray-600 mt-3 flex-grow">${excerpt}</p>
                    <a href="${postUrl}" class="mt-4 text-blue-600 font-semibold text-left self-start">Read Full Post →</a>
                </div>
            </div>
        `}).join('');
        lucide.createIcons();
    } catch (error) {
        console.error("Error loading blog posts:", error);
        container.innerHTML = '<p class="col-span-full text-center text-red-500">Error loading blog posts.</p>';
    }
}

// --- Single Post Page (post.html) ---
function getCurrentPostIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('slug') || params.get('id'); // Prefer slug, fallback to id
}

async function loadSinglePost(postIdOrSlug) {
    const container = document.getElementById('post-content-container');
    if (!container) return;
    container.innerHTML = '<p class="text-center text-gray-500">Loading post details...</p>';

    try {
        let postDoc;
        // Try fetching by slug first
        let q = query(collection(db, "blogs"), where("slug", "==", postIdOrSlug), limit(1));
        let querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            // If not found by slug, try fetching by ID (fallback)
            console.log("Post not found by slug, trying ID:", postIdOrSlug);
            const docRef = doc(db, "blogs", postIdOrSlug);
            const docSnap = await getDoc(docRef);
             if (docSnap.exists()) {
                 postDoc = { id: docSnap.id, ...docSnap.data() };
             }
        } else {
             const docSnap = querySnapshot.docs[0];
             postDoc = { id: docSnap.id, ...docSnap.data() };
        }


        if (postDoc && postDoc.status === 'published') {
            document.title = `${postDoc.title} - ArdayCaawiye Blog`; // Update page title

            container.innerHTML = `
                <img src="${postDoc.imageUrl || 'https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?q=80&w=870&auto=format=fit=crop'}" alt="${postDoc.title}" class="w-full h-64 md:h-80 object-cover rounded-lg mb-6">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">${postDoc.title}</h1>
                <p class="text-md text-gray-500 mt-2 mb-6">By ${postDoc.authorName || 'ArdayCaawiye Team'} • ${postDoc.createdAt ? postDoc.createdAt.toDate().toLocaleDateString() : ''}</p>
                <div class="prose lg:prose-xl max-w-none text-gray-700">${postDoc.content}</div>
            `;
            
            // Add share buttons
            addShareButtons(postDoc.title, window.location.href);

            // Load comments for this post ID
            loadComments(postDoc.id);

             // Render comment form (will show login prompt if needed)
             renderCommentForm(postDoc.id, currentUser);

        } else {
            container.innerHTML = '<h1 class="text-3xl font-bold text-red-600">Post Not Found</h1><p>The requested blog post could not be found or is not published.</p>';
        }
    } catch (error) {
        console.error("Error loading single post:", error);
        container.innerHTML = '<h1 class="text-3xl font-bold text-red-600">Error</h1><p>Could not load the blog post.</p>';
    }
     lucide.createIcons();
}

function addShareButtons(title, url) {
    const container = document.getElementById('share-container');
    if (!container) return;

    const encodedUrl = encodeURIComponent(url);
    const encodedTitle = encodeURIComponent(title);

    container.innerHTML = `
        <p class="font-semibold mb-2">Share this post:</p>
        <div class="share-buttons">
            <a href="https://api.whatsapp.com/send?text=${encodedTitle}%20${encodedUrl}" target="_blank" class="share-button share-whatsapp">
                <i data-lucide="message-circle"></i> WhatsApp
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}" target="_blank" class="share-button share-facebook">
                <i data-lucide="facebook"></i> Facebook
            </a>
            <button id="copy-link-btn" class="share-button share-copy">
                <i data-lucide="link"></i> Copy Link
            </button>
        </div>
    `;
    lucide.createIcons();

    // Add copy link functionality
    const copyBtn = document.getElementById('copy-link-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(url).then(() => {
                alert("Link copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy: ', err);
                 alert("Failed to copy link.");
            });
        });
    }
}

// --- Comment Loading and Submission (for post.html) ---
function renderCommentForm(postId, user) {
    const container = document.getElementById('comment-form-container');
    if (!container) return;
    container.dataset.postId = postId; // Store postId for submission
    
    if (user) {
        container.innerHTML = `
            <form id="comment-form" class="comment-form">
                <h4 class="text-xl font-bold mb-4">Leave a Comment</h4>
                <textarea id="comment-text" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Write your comment..." required></textarea>
                <button type="submit" class="mt-4 gradient-bg text-white font-bold py-2 px-6 rounded-lg hover:opacity-90">Post Comment</button>
            </form>
        `;
        // Remove previous listener if exists to prevent duplicates
        const oldForm = document.getElementById('comment-form');
         if(oldForm) {
            oldForm.replaceWith(oldForm.cloneNode(true)); // Clone to remove listeners
         }
         // Add new listener
         document.getElementById('comment-form')?.addEventListener('submit', handleCommentSubmit);

    } else {
        container.innerHTML = `
            <p class="text-gray-600">Please <a href="login.html" class="text-blue-600 font-semibold hover:underline">log in</a> to leave a comment.</p>
        `;
    }
}

async function handleCommentSubmit(e) {
    e.preventDefault();
    const container = document.getElementById('comment-form-container');
    const postId = container ? container.dataset.postId : null;
    const commentTextEl = document.getElementById('comment-text');
    const commentText = commentTextEl ? commentTextEl.value : null;
    const user = auth.currentUser;

    if (!postId || !commentText || !user) {
        alert("Could not post comment. Ensure you are logged in and the field is not empty.");
        return;
    }
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Posting...";
    }

    try {
        const commentsRef = collection(db, "blogs", postId, "comments");
        await addDoc(commentsRef, {
            text: commentText,
            authorId: user.uid,
            authorName: user.displayName || "Anonymous", // Use display name from auth profile
            createdAt: serverTimestamp()
        });
        if (commentTextEl) commentTextEl.value = ''; // Clear textarea
        // Firestore listener (loadComments) will automatically update the list
    } catch (error) {
        console.error("Error posting comment:", error);
        alert("Error posting comment.");
    } finally {
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = "Post Comment";
        }
    }
}

function loadComments(postId) {
    const container = document.getElementById('comment-list-container');
    if (!container) return;
    container.innerHTML = '<p class="text-gray-500">Loading comments...</p>';

    // Stop any previous listener
    if (commentsUnsubscribe) {
        console.log("Unsubscribing from previous comments listener.");
        commentsUnsubscribe();
        commentsUnsubscribe = null;
    }

    const commentsRef = query(collection(db, "blogs", postId, "comments"), orderBy("createdAt", "desc"));
    
    console.log("Setting up new comments listener for post:", postId);
    commentsUnsubscribe = onSnapshot(commentsRef, (snapshot) => {
         console.log(`Received ${snapshot.docs.length} comments.`);
        if (snapshot.empty) {
            container.innerHTML = '<p class="text-gray-500">No comments yet. Be the first!</p>';
            return;
        }
        
        container.innerHTML = snapshot.docs.map(doc => {
            const comment = doc.data();
            const dateString = comment.createdAt ? comment.createdAt.toDate().toLocaleString() : 'Just now';
            // Basic sanitization: replace < and > to prevent HTML injection
            const sanitizedText = (comment.text || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const sanitizedName = (comment.authorName || 'Anonymous').replace(/</g, "&lt;").replace(/>/g, "&gt;");

            return `
                <div class="comment">
                    <p class="comment-author">${sanitizedName}</p>
                    <p class="comment-date">${dateString}</p>
                    <p class="comment-body">${sanitizedText.replace(/\n/g, '<br>')}</p> 
                </div>
            `;
        }).join('');
    }, (error) => {
         console.error("Error fetching comments:", error);
         container.innerHTML = '<p class="text-red-500">Error loading comments.</p>';
    });
}


// =========================================================================
// Utility Functions
// =========================================================================

function createPlaceholder(count, type) {
    let classes = 'bg-gray-200 rounded-lg animate-pulse ';
    if (type === 'exam') classes += 'h-32';
    else if (type === 'book') classes += 'h-80';
    else classes += 'h-48'; // Default placeholder height
    return Array(count).fill().map(() => `<div class="${classes}"></div>`).join('');
}

function getSubjectIconUrl(subject) {
    const s_lower = (subject || 'general').toLowerCase();
    // Simplified keyword matching
    const keywords = ['physics', 'chemistry', 'biology', 'math', 'islamic', 'arabic', 'somali', 'english', 'history', 'geography'];
    const keyword = keywords.find(k => s_lower.includes(k)) || 'education'; // Default
    // Use a placeholder service for reliability
    // return `https://source.unsplash.com/random/200x240/?${keyword}`; // Unsplash can be unreliable
    return `https://placehold.co/200x240/e2e8f0/4a5568?text=${keyword.charAt(0).toUpperCase() + keyword.slice(1)}`;
}

function renderPagination(totalPages, containerId, pageChangeCallback) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const currentPage = containerId === 'exams-pagination' ? currentExamPage : currentBookPage;

    if (totalPages <= 1) {
        container.innerHTML = ''; return;
    }
    
    let html = `<button data-page="prev" class="pagination-btn">< Prev</button>`;
    
    const pages = [];
    const maxPagesToShow = 5; // How many page numbers max (excluding ellipsis)
    if (totalPages <= maxPagesToShow + 2) { // Show all if not many pages
        for (let i = 1; i <= totalPages; i++) pages.push(i);
    } else {
        pages.push(1); // Always show first page
        let startPage, endPage;
        if (currentPage <= Math.ceil(maxPagesToShow / 2)) {
             startPage = 2;
             endPage = maxPagesToShow;
             if (endPage < totalPages -1) pages.push('...');
        } else if (currentPage >= totalPages - Math.floor(maxPagesToShow / 2)) {
             startPage = totalPages - maxPagesToShow + 1;
             endPage = totalPages - 1;
              pages.push('...');
        } else {
            startPage = currentPage - Math.floor((maxPagesToShow - 2) / 2);
            endPage = currentPage + Math.ceil((maxPagesToShow - 2) / 2);
             pages.push('...');
             if (endPage < totalPages -1) pages.push('...'); // Ellipsis after if needed
        }
        
        for (let i = startPage; i <= endPage; i++) {
             pages.push(i);
        }
        
        pages.push(totalPages); // Always show last page
    }

    const uniquePages = [...new Set(pages)]; // Ensure no duplicates if logic overlaps slightly
    uniquePages.forEach(p => {
        if (p === '...') {
            html += `<span class="px-2 py-2 hidden md:inline">...</span>`;
        } else {
            html += `<button data-page="${p}" class="pagination-btn ${p === currentPage ? 'active' : ''}">${p}</button>`;
        }
    });

    html += `<button data-page="next" class="pagination-btn">Next ></button>`;
    container.innerHTML = html;

    // Add listeners after rendering
    container.querySelectorAll('.pagination-btn').forEach(btn => {
        const page = btn.dataset.page;
        if (page === 'prev') {
            btn.disabled = currentPage === 1;
            btn.addEventListener('click', () => pageChangeCallback(currentPage - 1));
        } else if (page === 'next') {
            btn.disabled = currentPage === totalPages;
            btn.addEventListener('click', () => pageChangeCallback(currentPage + 1));
        } else {
            // Check if it's a number before adding listener
            if (!isNaN(parseInt(page))) {
                 btn.addEventListener('click', () => pageChangeCallback(parseInt(page)));
            }
        }
    });
}

function stripHtml(html) {
   let tmp = document.createElement("DIV");
   tmp.innerHTML = html;
   return tmp.textContent || tmp.innerText || "";
}

// --- Modal Controls ---
window.showPdfPreviewModal = function(url, title) { // Make it globally accessible
    const titleEl = document.getElementById('pdf-title');
    if (titleEl) titleEl.textContent = title || "Access Full Document";
    if (pdfModal) pdfModal.style.display = 'flex';
}
if(closeModalBtn) closeModalBtn.onclick = () => { if(pdfModal) pdfModal.style.display = 'none'; };

function showComingSoonPopup(e) {
    if (e) e.preventDefault(); // Prevent navigation if called from link
    if (comingSoonModal) comingSoonModal.style.display = 'flex';
}
function hideComingSoonPopup() {
    if (comingSoonModal) comingSoonModal.style.display = 'none';
}
if(closeComingSoonBtn) closeComingSoonBtn.addEventListener('click', hideComingSoonPopup);
if(comingSoonOkBtn) comingSoonOkBtn.addEventListener('click', hideComingSoonPopup);

// --- Auth Form Logic (for login.html) ---
// Note: Assumes login.html includes an element with id="auth-container-login"
function renderAuthForm(isLogin = true) {
     // Only render if on the login page and the container exists
     const authContainer = document.getElementById('auth-container-login'); // Use specific ID for login page
     if (!authContainer || currentPage !== 'login.html') return;

    authContainer.innerHTML = `
        <h2 class="text-2xl font-bold text-center mb-1">${isLogin ? 'Welcome Back!' : 'Create Account'}</h2>
        <p class="text-gray-500 text-center mb-6">${isLogin ? 'Log in to continue.' : 'Sign up to get started.'}</p>
        <form id="auth-form" class="space-y-4">
            ${!isLogin ? '<input type="text" id="username" placeholder="Full Name" required class="w-full p-3 border rounded-lg">' : ''}
            <input type="email" id="email" placeholder="Email" required class="w-full p-3 border rounded-lg">
            <input type="password" id="password" placeholder="Password (min. 6 characters)" required class="w-full p-3 border rounded-lg">
            <div id="auth-error" class="text-red-500 text-sm"></div>
            <button type="submit" class="w-full gradient-bg text-white font-bold py-3 rounded-lg">${isLogin ? 'Log In' : 'Sign Up'}</button>
        </form>
        <p class="text-center text-sm mt-4">
            ${isLogin ? "Don't have an account?" : "Already have an account?"} 
            <button id="auth-toggle" class="font-semibold text-blue-600 hover:underline">${isLogin ? 'Sign Up' : 'Log In'}</button>
        </p>`;
    
    // Attach listeners after rendering
    const authForm = document.getElementById('auth-form');
    const authToggle = document.getElementById('auth-toggle');

    if (authToggle) authToggle.addEventListener('click', () => renderAuthForm(!isLogin));
    if (authForm) authForm.addEventListener('submit', (e) => { 
        e.preventDefault(); 
        const isLoginForm = !document.getElementById('username'); // Check if username field exists
        isLoginForm ? handleLogin() : handleSignup(); 
    });
}

function handleLogin() {
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const errorEl = document.getElementById('auth-error');
    if (!emailEl || !passwordEl || !errorEl) return; // Elements not found

    const email = emailEl.value;
    const password = passwordEl.value;
    errorEl.textContent = ''; // Clear previous errors

    signInWithEmailAndPassword(auth, email, password)
        .then(() => {
             // Redirect handled by onAuthStateChanged
             console.log("Login successful, redirecting...");
        })
        .catch(err => {
             errorEl.textContent = err.message; // Show login error
        });
}

function handleSignup() {
     const usernameEl = document.getElementById('username');
     const emailEl = document.getElementById('email');
     const passwordEl = document.getElementById('password');
     const errorEl = document.getElementById('auth-error');
     if (!usernameEl || !emailEl || !passwordEl || !errorEl) return;

    const username = usernameEl.value;
    const email = emailEl.value;
    const password = passwordEl.value;
    errorEl.textContent = '';

    createUserWithEmailAndPassword(auth, email, password).then(cred => {
        // Set user document in Firestore
        const userDocRef = doc(db, "users", cred.user.uid);
        return setDoc(userDocRef, { 
            displayName: username, 
            email: email, 
            role: 'user', // Default role
            isPremium: false, 
            banned: false, // Default banned status
            createdAt: serverTimestamp(),
            uid: cred.user.uid 
        })
        .then(() => {
            // Update auth profile display name
            return updateProfile(cred.user, { displayName: username });
        })
        .then(() => {
             // Redirect handled by onAuthStateChanged
             console.log("Signup successful, redirecting...");
        });
    }).catch(err => {
         errorEl.textContent = err.message; // Show signup error
    });
}

// --- Contact Form ---
const contactForm = document.getElementById('contact-form');
if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameEl = document.getElementById('contact-name');
        const emailEl = document.getElementById('contact-email');
        const messageEl = document.getElementById('contact-message');
        const successMsg = document.getElementById('contact-success');
        const submitBtn = contactForm.querySelector('button[type="submit"]');

        if (!nameEl || !emailEl || !messageEl || !successMsg || !submitBtn) return;

        const name = nameEl.value;
        const email = emailEl.value;
        const message = messageEl.value;
        
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";

        try {
            await addDoc(collection(db, "contact"), {
                name, email, message, sentAt: serverTimestamp(), read: false // Add 'read' status
            });
            contactForm.reset();
            successMsg.classList.remove('hidden');
            setTimeout(() => successMsg.classList.add('hidden'), 4000);
        } catch (error) {
            console.error("Error sending contact message: ", error);
            alert('There was an error sending your message. Please try again.');
        } finally {
             submitBtn.disabled = false;
             submitBtn.textContent = "Send Message";
        }
    });
}

// --- Animations & Other Effects ---
function initializeAnimations() {
    // Reveal on scroll
    const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

    // Stat counter animation
    const numberFormatter = (num) => {
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
        return num.toString();
    }
    const statsObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const counter = entry.target.querySelector('h3[data-target]');
                if (!counter || counter.dataset.animated) return;
                
                counter.dataset.animated = "true";
                const target = +counter.dataset.target;
                const isPercent = counter.textContent.includes('%');
                let current = 0;
                const duration = 1500; // ms
                const stepTime = 16; // approx 60fps
                const steps = duration / stepTime;
                const increment = target / steps;

                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        clearInterval(timer);
                        counter.textContent = numberFormatter(target) + (isPercent ? '%' : '');
                    } else {
                        counter.textContent = numberFormatter(Math.ceil(current));
                    }
                }, stepTime);
                observer.unobserve(entry.target); // Animate only once
            }
        });
    }, { threshold: 0.8 });
    document.querySelectorAll('.stat-card').forEach(card => statsObserver.observe(card));
}

function setupCarousel() {
    const track = document.getElementById('carousel-track');
    const container = document.getElementById('carousel-track-container');
    if (!track || !container || track.children.length === 0 || track.dataset.initialized) return;
    
    track.dataset.initialized = "true"; // Prevent re-initialization

    const slides = Array.from(track.children);
    const originalSlideCount = slides.length;
    
    let slideWidth, slidesInView;

    function calculateCarouselLayout() {
        slideWidth = container.clientWidth; 
        slidesInView = window.innerWidth < 768 ? 1 : (window.innerWidth < 1024 ? 2 : 3);
        const itemWidth = slideWidth / slidesInView;

        // Apply width to original and cloned slides
        Array.from(track.children).forEach(slide => {
             slide.style.width = `${itemWidth}px`;
             slide.style.flexShrink = '0'; // Ensure slides don't shrink
        });
        
        // Reset transform immediately after width change
        track.style.transition = 'none';
        track.style.transform = `translateX(-${currentIndex * itemWidth}px)`;
    }
    
    // Clone only if needed for looping
    if (originalSlideCount > slidesInView) {
         for (let i = 0; i < originalSlideCount; i++) {
             track.appendChild(slides[i].cloneNode(true));
         }
    } else {
         // Not enough slides to clone or loop, just set widths
         calculateCarouselLayout();
         return; // No interval needed
    }
    
    let currentIndex = 0;
    let intervalId = null;

    function startCarouselInterval() {
         if (intervalId) clearInterval(intervalId); // Clear existing interval

         calculateCarouselLayout(); // Calculate layout on start/restart

         intervalId = setInterval(() => {
             currentIndex++;
             track.style.transition = 'transform 0.5s ease-in-out';
             const currentItemWidth = track.children[0].getBoundingClientRect().width; // Get current width
             track.style.transform = `translateX(-${currentIndex * currentItemWidth}px)`;

             // Use a separate listener for transition end to reset
             const resetTransition = () => {
                 if (currentIndex >= originalSlideCount) {
                     track.style.transition = 'none';
                     currentIndex = 0;
                     track.style.transform = `translateX(0)`;
                 }
                 track.removeEventListener('transitionend', resetTransition); // Clean up listener
             };
             track.addEventListener('transitionend', resetTransition);

         }, 5000); // Change slide every 5 seconds
    }

    // Debounced resize handler
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
             console.log("Resizing carousel...");
             if (originalSlideCount > slidesInView) { // Only restart if looping
                 startCarouselInterval(); // Recalculate widths and restart interval
             } else {
                 calculateCarouselLayout(); // Just recalculate widths if not looping
             }
        }, 250); // Debounce time
    });

    startCarouselInterval(); // Initial start
}

// --- General Event Listeners ---
if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => mobileMenu?.classList.toggle('hidden'));

// Close mobile menu when a link inside it is clicked
if(mobileMenu) {
     mobileMenu.addEventListener('click', (e) => {
         if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
             mobileMenu.classList.add('hidden');
         }
     });
}

// --- Initialize App ---
document.addEventListener('DOMContentLoaded', () => {
    loadSiteSettings(); // Load dynamic links immediately
    initializeAnimations(); // Set up scroll/counter animations
    lucide.createIcons(); // Initial icon rendering

    // Page specific initializations are handled within the currentPage checks
});

    <script src="app.js" type="module" defer></script>
</body>
</html>
